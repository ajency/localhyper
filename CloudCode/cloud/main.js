(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;Parse.Cloud.define("getAttribValueMapping",function(b,c){var d,e,f,g,h,i,j,k;return g=b.params.categoryId,i=b.params.filterableAttributes,k=b.params.secondaryAttributes,f=Parse.Object.extend("Category"),e=Parse.Object.extend("Attributes"),d=Parse.Object.extend("AttributeValues"),h=new Parse.Query("Category"),h.equalTo("objectId",g),i&&(h.include("filterable_attributes"),h.include("filterable_attributes.filterAttribute")),k&&h.include("secondary_attributes"),j=h.first(),j.done(function(b){return function(b){var d,e,f,g,h;return f=[],i&&(e=b.get("filterable_attributes"),e&&e.length>0&&(d=[],d=a.map(e,function(a){return a.get("filterAttribute")}),f=d)),k&&(h=b.get("secondary_attributes"),h&&h.length>0&&(f=a.union(d,h))),g=[],g=a.map(f,function(a){var b,c,d,e;return b=a.id,c=[],d=new Parse.Query("Attributes"),d.equalTo("objectId",b),e=new Parse.Query("AttributeValues"),e.matchesQuery("attribute",d),e.include("attribute"),e.find()}),Parse.Promise.when(g).then(function(){var b,d,e,g;return e=a.flatten(a.toArray(arguments)),d=[],a.each(e,function(a){var b;return b={attributeId:a.get("attribute").id,attributeName:a.get("attribute").get("name"),group:a.get("attribute").get("group"),displayType:a.get("attribute").get("displayType"),valueId:a.id,value:a.get("value")},d.push(b)}),Parse.Promise.as(),b=a.map(f,function(a){return a={id:a.id,name:a.get("name"),type:a.get("type")}}),g={attributes:b,attributeValues:d},c.success(g)},function(a){return c.error(a)})}}(this))}),Parse.Cloud.define("attributeImport",function(b,c){var d,e,f,g,h,i,j;return d=Parse.Object.extend("Attributes"),e=[],f=b.params.attributes,g=b.params.categoryId,h=b.params.isFilterable,i=b.params.primaryAttributeObj,a.each(f,function(b){var c;return a.isNull(b.name)?void 0:(c=new d,a.isNull(b.objectId)||(c.id=b.objectId),c.set("name",b.name),c.set("group",b.group),a.isNull(b.unit)||c.set("unit",b.unit),b.hasOwnProperty("display_type")?c.set("display_type",b.display_type):c.set("display_type","checkbox"),b.hasOwnProperty("type")?c.set("type",b.type):c.set("type","select"),e.push(c))}),j=[],u(i).then(function(b){return Parse.Object.saveAll(e).then(function(d){var e,f,i,k;return a.isEmpty(b)||d.push(b),e=Parse.Object.extend("Category"),i=new e,i.id=g,f=Parse.Object.extend("ProductFilters"),h===!0?(k=new Parse.Query("ProductFilters"),k.equalTo("categoryId",g),k.find().then(function(e){return Parse.Object.destroyAll(e).then(function(e){var h,k;return h=1,k=[],a.each(d,function(a){var b;return b=new f,b.set("categoryId",g),b.set("filterColumn",h),b.set("filterAttribute",a),h++,k.push(b)}),Parse.Object.saveAll(k).then(function(d){return i.set("filterable_attributes",d),a.isEmpty(b)||(j.push(b),i.set("primary_attributes",j)),i.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the attributes (with primary)"},c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error("1. error due to "+a)})},function(a){return c.error(a)})):(i.set("secondary_attributes",d),a.isEmpty(b)||(j.push(b),i.set("primary_attributes",j)),i.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the attributes (with primary)"},c.success(b)},function(a){return c.error(a)}))},function(a){return c.error("Failed to add/update attributes due to - "+a.message)})},function(a){return c.error("Failed to save/update primary attribute due to - "+a.message)})}),Parse.Cloud.define("attributeValueImport",function(b,c){var d,e,f,g;return d=Parse.Object.extend("AttributeValues"),e=[],f=b.params.attributeValues,g=b.params.categoryId,a.each(f,function(b){var c,f,g;return a.isNull(b.attributeId)||a.isNull(b.value)?void 0:(f=new d,a.isNull(b.objectId)||(f.id=b.objectId),g=String(b.value),f.set("value",g),c={__type:"Pointer",className:"Attributes",objectId:b.attributeId},f.set("attribute",c),e.push(f))}),Parse.Object.saveAll(e,{success:function(a){var b;return b={success:!0,message:"Successfully added/updated the attribute valuess"},c.success(b)},error:function(a){return c.error("Failed to add/update attributes due to - "+a.message)}})}),u=function(b){var c,d,e;return c=Parse.Object.extend("Attributes"),e=new Parse.Promise,a.isEmpty(b)||a.isNull(b.name)?(b={},e.resolve(b)):(d=new c,a.isNull(b.objectId)||(d.id=b.objectId),d.set("name",b.name),d.set("group",b.group),""!==b.unit&&d.set("unit",b.unit),b.hasOwnProperty("display_type")?d.set("display_type",b.display_type):d.set("display_type","checkbox"),b.hasOwnProperty("type")?d.set("type",b.type):d.set("type","select"),d.save().then(function(a){return e.resolve(a)},function(a){return e.reject(a)})),e},Parse.Cloud.define("getCategoryBasedBrands",function(a,b){var c,d;return c=a.params.categoryId,d=new Parse.Query("Category"),d.equalTo("objectId",c),d.include("supported_brands"),d.select("supported_brands"),d.first().then(function(a){return b.success(a)},function(a){return b.error("Error - "+a.message)})}),Parse.Cloud.define("brandImport",function(b,c){var d,e,f,g;return d=Parse.Object.extend("Brand"),f=[],e=b.params.brands,g=b.params.categoryId,a.each(e,function(b){var c,e;return a.isNull(b.name)?void 0:(c=new d,a.isNull(b.objectId)||(c.id=b.objectId),c.set("name",b.name),e=a.isNull(b.imageUrl)?{src:"https://placehold.it/350x150?text=Brand"}:{src:b.imageUrl},c.set("image",e),f.push(c))}),Parse.Object.saveAll(f,{success:function(a){var b,d;return b=Parse.Object.extend("Category"),d=new b,d.id=g,d.set("supported_brands",a),d.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the brands"},c.success(b)},function(a){return c.error(a)})},error:function(a){return c.error(a)}})}),a=require("underscore.js"),r=require("cloud/moment"),v=function(a,b,c,d){var e,f;return b||(b="id"),c||(c="parent"),d||(d="children"),f=[],e={},a.forEach(function(a){e[a[b]]=a,a[d]=[]}),a.forEach(function(a){var b;null!==a[c]?(b=a[c],e[b][d].push(a)):f.push(a)}),f},Parse.Cloud.define("getCategories",function(b,c){var d,e,f,g;return g=b.params.sortBy,d=Parse.Object.extend("Category"),e=new Parse.Query(d),e.include("parent_category"),f=e.find(),f.done(function(b){return function(b){var d,e,f;return e=[],a.each(b,function(b){var c,d;return c={id:b.id,name:b.get("name"),sort_order:b.get("sort_order"),image:b.get("image")},a.isObject(b.get("parent_category"))?(d=b.get("parent_category"),c.parent=d.id):c.parent=null,e.push(c)}),d=v(e,"id","parent","children"),f={success:!0,data:a.sortBy(d,g)},c.success(f)}}(this)),f.fail(function(a){return function(a){var b;return b={success:!1,errorCode:a.code,msg:a.msg},c.error(b)}}(this))}),Parse.Cloud.define("getCreditHistory",function(b,c){var d,e,f,g,h;return h=b.params.sellerId,d=b.params.displayLimit,f=b.params.page,e=new Parse.Query(Parse.User),e.equalTo("objectId",h),g=new Parse.Query("Transaction"),g.matchesQuery("seller",e),g.descending("createdAt"),g.include("offer"),g.include("offer.request"),g.include("offer.request.product"),g.limit(d),g.skip(f*d),g.find().then(function(b){var d;return 0===b.length?c.success(b):(d=[],a.each(b,function(b){var c,e,f,g,h,i,j;return a.isUndefined(b.get("offer"))?(c={},f={}):(e=b.get("offer"),h=e.get("request"),g=h.get("product"),c={id:e.id,status:e.get("status"),createdAt:e.createdAt,updatedAt:e.updatedAt},f={name:g.get("name"),model_number:g.get("model_number")}),i=a.isUndefined(b.get("towards"))?"":b.get("towards"),j={id:b.id,createdAt:b.createdAt,transactionType:b.get("transactionType"),transactionTowards:i,creditCount:b.get("creditCount"),offer:c,product:f},d.push(j)}),c.success(d))},function(a){return c.error(a)})}),Parse.Cloud.define("addCredits",function(a,b){var c,d,e;return e=a.params.sellerId,c=parseInt(a.params.newAddedCredits),d=new Parse.Query(Parse.User),d.equalTo("objectId",e),d.first().then(function(a){var d,e;return d=Parse.Object.extend("Transaction"),e=new d,e.set("seller",a),e.set("transactionType","add"),e.set("creditCount",c),e.save().then(function(d){var e,f;return e=a.get("addedCredit"),f=e+c,a.set("addedCredit",f),a.save().then(function(a){var c;return c={sellerId:a.id,sellerCredits:a.get("addedCredit")},b.success(c)},function(a){return b.error(a)})})},function(a){return b.error(a)})}),t=function(a){var b,c,d;return c=new Parse.Promise,d=new Parse.Query("Offer"),b=new Parse.Query("Request"),b.equalTo("objectId",a),d.matchesQuery("request",b),d.count().then(function(b){var d,e;return d=Parse.Object.extend("Request"),e=new d,e.id=a,e.set("offerCount",b),e.save().then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return response.error(a)}),c},Parse.Cloud.define("updateRequestOfferCount",function(b,c){var d,e,f;return d=b.params.customerId,f=new Parse.Query("Request"),e=new Parse.Query(Parse.User),e.equalTo("objectId",d),f.matchesQuery("customerId",e),f.find().then(function(b){var d;return d=[],d=a.map(b,function(a){return t(a.id)}),Parse.Promise.when(d).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("sendMail",function(a,b){var c,d,e,f,g,h,i;return h=a.params.productName,e=a.params.category,d=a.params.brand,g=a.params.description,f=a.params.comments,i="<p>Product Name:"+h+"<br> Category:"+e+"<br> Brand: "+d,null!==g&&(i+="<br> Description: "+g),null!==f&&(i+="<br> Comments: "+f),i+="</p>",c=require("mandrill"),c.initialize("JGQ1FMECVDSJLnOFvxDzaQ"),c.sendEmail({message:{html:"<p>"+i+"</p>",text:i,subject:"Product suggestions",from_email:"parse@cloudcode.com",from_name:"Cloud Code",to:[{email:"namrata@ajency.in",name:"ShopOye"},{email:"ashika@ajency.in ",type:"cc"}]},async:!0},{success:function(a){return console.log(a),b.success("Mail Sent")},error:function(a){return console.error(a),b.error("err")}})}),j=function(b,c,d){var e,f;return f=new Parse.Promise,e=new Parse.Query(Parse.Installation),e.equalTo("installationId",c),e.find().then(function(e){var g,h,i;return g=a.isEmpty(e)?"unknown":e[0].get("deviceType"),i="android"===g.toLowerCase()?{header:d.title,message:d.alert,data:d.notificationData}:{title:d.title,alert:d.alert,data:d.notificationData,badge:"Increment"},h={pushData:i,installationId:c,notificationId:b},f.resolve(h)},function(a){return f.reject(a)}),f},s=function(a,b,c){var d,e;return d=new Parse.Promise,e=new Parse.Query(Parse.Installation),e.equalTo("installationId",a),Parse.Push.send({where:e,data:b}).then(function(){var a,b;return a=Parse.Object.extend("Notification"),b=new Parse.Query(a),b.equalTo("objectId",c),b.first().then(function(a){return a.set("processed",!0),a.save().then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d},Parse.Cloud.job("processNotifications",function(b,c){var d;return d=new Parse.Query("Notification"),d.equalTo("processed",!1),d.include("recipientUser"),d.include("requestObject"),d.include("requestObject.product"),d.include("offerObject"),d.include("offerObject.request"),d.include("offerObject.request.product"),d.find().then(function(b){var d,e,f;return e=[],f="ShopOye Seller",d="ShopOye Customer",a.each(b,function(a){var b,c,g,h,i,k,l,m,n,o,p,q;switch(b=a.get("channel"),n=a.get("recipientUser"),g=a.id,q=n.get("installationId"),p=a.get("type"),"Request"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=f,c="New request for "+l,k={id:i.id,type:"new_request"}):"Offer"===p?(i=a.get("offerObject"),l=a.get("offerObject").get("request").get("product").get("name"),o=d,c="New offer for "+l,k={id:i.id,type:"new_offer"}):"AcceptedOffer"===p?(i=a.get("offerObject"),l=a.get("offerObject").get("request").get("product").get("name"),o=f,c="Offer accepted for "+l,k={id:i.id,type:"accepted_offer"}):"CancelledRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=f,c="Request cancelled for "+l,k={id:i.id,type:"cancelled_request"}):"SentForDeliveryRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c=l+" is sent for delivery",k={id:i.id,type:"sent_for_delivery_request"}):"FailedDeliveryRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c="Delivery failed for "+l,k={id:i.id,type:"failed_delivery_request"}):"SuccessfulRequest"===p&&(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c="Delivery successful for "+l,k={id:i.id,type:"successful_request"}),b){case"push":return m={title:o,alert:c,notificationData:k},h=j(g,q,m),e.push(h);case"sms":return console.log("send sms")}}),Parse.Promise.when(e).then(function(){var b,d;return b=a.flatten(a.toArray(arguments)),d=[],a.each(b,function(a){var b,c,e;return b=a.installationId,c=a.notificationId,e=s(b,a.pushData,c),d.push(e)}),Parse.Promise.when(d).then(function(){return c.success("Processed")},function(a){return c.error(a)})},function(a){return c.error("Error")})},function(a){return c.error(a)})}),Parse.Cloud.define("getUnseenNotifications",function(b,c){var d,e,f,g;return g=b.params.userId,f=b.params.type,e=new Parse.Query("Notification"),e.equalTo("hasSeen",!1),d=new Parse.Query(Parse.User),d.equalTo("objectId",g),e.matchesQuery("recipientUser",d),e.equalTo("type",f),e.include("requestObject"),e.select("requestObject"),e.select("offerObject"),e.find().then(function(b){var d;return d=[],"Request"===f?a.each(b,function(a){var b,c,e,f,g,h,i;return h=a.get("requestObject"),c=new Date,b=h.createdAt,e=c.getTime()-b.getTime(),f=Math.floor(e/864e5),i=h.get("status"),f>=1&&"open"===i&&(i="expired"),"open"===i?(g=a.get("requestObject").id,d.push(g)):void 0}):"Offer"===f&&(d=a.map(b,function(a){var b;return b=a.get("offerObject").id})),c.success(d)},function(a){return c.error(a)})}),Parse.Cloud.define("updateNotificationStatus",function(b,c){var d,e,f,g,h,i,j;return g=b.params.notificationType,h=b.params.notificationTypeId,i=b.params.recipientId,d=b.params.hasSeen,f=new Parse.Query("Notification"),f.equalTo("type",g),j={__type:"Pointer",className:"_User",objectId:i},f.equalTo("recipientUser",j),"Request"===g?(e=new Parse.Query("Request"),e.equalTo("objectId",h),f.matchesQuery("requestObject",e)):"Offer"===g&&(e=new Parse.Query("Offer"),a.isArray(h)?e.containedIn("objectId",h):a.isString(h)&&e.equalTo("objectId",h),f.matchesQuery("offerObject",e)),f.find().then(function(b){var e;return e=a.map(b,function(a){return a.set("hasSeen",d),a.save()}),Parse.Promise.when(e).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getNewOffers",function(b,c){var d,e,f,g,h;return g=b.params.productId,d=b.params.customerId,f=new Parse.Query("ProductItem"),f.equalTo("objectId",g),e=new Parse.Query(Parse.User),e.equalTo("objectId",d),h=new Parse.Query("Request"),h.matchesQuery("product",f),h.matchesQuery("customerId",e),h.first().then(function(b){var d,g,h,i,j,k,l,m;return a.isEmpty(b)?(i=!1,l={activeRequest:{},offers:[],moreRequests:i},c.success(l)):(i=!0,k=new Parse.Query("Request"),k.matchesQuery("product",f),k.matchesQuery("customerId",e),d=new Date,g=d.getTime(),h=24,j=new Date,m=g-60*h*60*1e3,j.setTime(m),k.greaterThanOrEqualTo("createdAt",j),k.descending("createdAt"),k.find().then(function(a){var b,d,e,f;return 0===a.length?(l={activeRequest:{},offers:[],moreRequests:i},c.success(l)):(d=a[0],f=d.get("status"),"open"===f?(e=new Parse.Query("Offer"),b=new Parse.Query("Request"),b.equalTo("objectId",d.id),e.matchesQuery("request",b),e.equalTo("status","open"),e.find().then(function(a){return l={activeRequest:d,offers:a,moreRequests:i},c.success(l)},function(a){return c.error(a)})):(l={activeRequest:{},offers:[],moreRequests:i},c.success(l)))},function(a){return c.error(a)}))},function(a){return c.error(a)})}),Parse.Cloud.define("makeOffer",function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;return l=a.params.requestId,n=a.params.sellerId,k=parseInt(a.params.priceValue),i=a.params.deliveryTime,h=a.params.comments,o=a.params.status,j=1,g=5,e=Parse.Object.extend("Price"),d=Parse.Object.extend("Offer"),f=Parse.Object.extend("Request"),c=Parse.Object.extend("Notification"),m=new Parse.Query("Request"),m.equalTo("objectId",l),m.first().then(function(a){var g,m,p,q,r,s;return r=a.get("customerId"),g=a.createdAt,q=a.get("addressGeoPoint"),m=new e,m.set("source","seller"),s=new Parse.User,s.id=n,m.set("seller",s),m.set("type","open_offer"),m.set("value",k),p=a.get("product"),m.set("product",p),m.save().then(function(e){var g,m;return g=new d,m=new f,m.id=l,g.set("seller",s),g.set("request",m),g.set("price",e),g.set("status",o),g.set("deliveryTime",i),g.set("comments",h),g.set("requestDate",a.createdAt),g.set("offerPrice",k),g.set("requestGeoPoint",a.get("addressGeoPoint")),g.save().then(function(a){var d,e;return d=Parse.Object.extend("Transaction"),e=new d,e.set("seller",s),e.set("transactionType","minus"),e.set("creditCount",j),e.set("towards","make_offer"),e.set("offer",a),e.save().then(function(d){return s.fetch().then(function(e){var f,g;return g=e.get("subtractedCredit"),f=g+d.get("creditCount"),s.set("subtractedCredit",f),e.save().then(function(d){var e;return e=new c,e.set("hasSeen",!1),e.set("recipientUser",r),e.set("channel","push"),e.set("processed",!1),e.set("type","Offer"),e.set("offerObject",a),e.save().then(function(a){return b.success(a)},function(a){return b.error(a)})},function(a){return b.error(a)})},function(a){return b.error(a)})},function(a){return b.error(a)})},function(a){return b.error(a)})},function(a){return b.error(a)})},function(a){return b.error(a)})}),Parse.Cloud.define("getSellerOffers",function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;return o=b.params.sellerId,n=b.params.sellerGeoPoint,k=parseInt(b.params.page),h=parseInt(b.params.displayLimit),d=b.params.acceptedOffers,m=b.params.selectedFilters,p=b.params.sortBy,g=b.params.descending,j=new Parse.Query(Parse.User),j.equalTo("objectId",o),l=new Parse.Query("Offer"),l.matchesQuery("seller",j),d===!0?(f=["accepted"],e=0===m.length?["pending_delivery","sent_for_delivery","failed_delivery","successful"]:m,i=new Parse.Query("Request"),i.containedIn("status",e),l.matchesQuery("request",i),l.containedIn("status",f)):(f=0===m.length?["open","unaccepted"]:a.without(m,"expired"),l.containedIn("status",f)),l.limit(h),l.skip(k*h),"distance"===p?l.near("requestGeoPoint",n):(q="offerPrice"===p?"offerPrice":"expiryTime"===p?"requestDate":"updatedAt"===p?"updatedAt":"deliveryDate"===p?"deliveryDate":"updatedAt",g===!0?l.descending(q):l.ascending(q)),l.include("price"),l.include("request"),l.include("seller"),l.include("price"),l.include("request.product"),l.include("request.brand"),l.include("request.category"),l.include("request.category.parent_category"),l.find().then(function(d){var e;return e=[],a.each(d,function(c){var d,f,g,h,i,j,k,l,m,o,p,q,r,s,t,u,v,w;return s=c.get("request"),q=s.get("product"),f=s.get("brand"),h=s.get("category"),u=c.get("seller"),o=c.get("price"),p={objectId:q.id,name:q.get("name"),mrp:q.get("mrp"),modelNumber:q.get("model_number"),images:q.get("images")},d={objectId:f.id,name:f.get("name")},g={objectId:h.id,name:h.get("name"),parentCategory:h.get("parent_category").get("name")},n=u.get("addressGeoPoint"),r=s.get("addressGeoPoint"),w=r.kilometersTo(n),j=new Date,i=s.createdAt,k=j.getTime()-i.getTime(),l=Math.floor(k/864e5),t=s.get("status"),l>=1&&"open"===t&&(t="expired"),m=s.get("failedDeliveryReason"),a.isNull(m)&&(m=""),b={id:s.id,address:s.get("address"),status:t,differenceInDays:l,offerCount:s.get("offerCount"),comments:s.get("comments"),failedDeliveryReason:m,createdAt:s.createdAt},v={id:c.id,product:p,brand:d,category:g,request:b,distanceFromCustomer:w,offerPrice:o.get("value"),offerStatus:c.get("status"),offerDeliveryTime:c.get("deliveryTime"),offerDeliveryDate:c.get("deliveryDate"),offerDeliveryDate:c.get("deliveryDate"),offerComments:c.get("comments"),createdAt:c.createdAt,updatedAt:c.updatedAt},e.push(v)}),c.success(e)},function(a){return c.error(a)})}),Parse.Cloud.afterSave("Offer",function(a){var b,c,d,e;return c=a.object,c.existed()?void 0:(e=c.get("request").id,b=Parse.Object.extend("Request"),d=new Parse.Query(b),d.get(e).then(function(a){return a.increment("offerCount"),a.save()},function(a){return console.log("Got an error "+a.code+" : "+a.message)}))}),Parse.Cloud.define("getRequestOffers",function(b,c){var d,e,f;return f=b.params.requestId,e=new Parse.Query("Offer"),d=new Parse.Query("Request"),d.equalTo("objectId",f),e.matchesQuery("request",d),e.include("price"),e.include("request"),e.include("request.product"),e.include("seller"),e.find().then(function(b){var d;return d=[],d=a.map(b,function(a){var b,c,d,e,f,g;return e=a.get("request").get("product"),d={name:e.get("name"),images:e.get("images")},g=a.get("seller"),f={displayName:g.get("displayName"),businessName:g.get("businessName"),address:g.get("address"),city:g.get("city"),phoneNumber:g.get("username")},c=a.get("price"),b={id:a.id,product:d,seller:f,price:c.get("value"),comments:a.get("comments"),deliveryTime:a.get("deliveryTime"),status:a.get("status"),createdAt:a.createdAt,updatedAt:a.updatedAt}}),c.success(d)},function(a){return c.error(a)})}),Parse.Cloud.define("acceptOffer",function(b,c){var d,e,f,g,h,i,j;return g=b.params.offerId,j=b.params.unacceptedOfferIds,e=5,d=Parse.Object.extend("Offer"),i=[],f={id:g,status:"accepted"},i.push(f),j.length>0&&a.each(j,function(a){var b;return b={id:a,status:"unaccepted"},i.push(b)}),h=[],a.each(i,function(a){var b;return b=new d,b.id=a.id,b.set("status",a.status),h.push(b)}),Parse.Object.saveAll(h).then(function(a){var b;return b=new Parse.Query("Offer"),b.equalTo("objectId",g),b.include("request"),b.include("seller"),b.first().then(function(a){var b,d,f;return d=a.get("seller"),b=Parse.Object.extend("Transaction"),f=new b,f.set("seller",d),f.set("transactionType","minus"),f.set("creditCount",e),f.set("towards","accept_offer"),f.set("offer",a),f.save().then(function(b){var e,f;return f=d.get("subtractedCredit"),e=f+b.get("creditCount"),d.set("subtractedCredit",e),d.save().then(function(b){var e,f,g,h,i,j,k;return i=a.get("request"),e=a.get("deliveryTime"),g=parseInt(e.value),h=a.updatedAt,j=["Sunday","Monday"],k=["9:00:00","18:00:00"],f=r(h).add(g,"hours").toDate(),a.set("deliveryDate",f),a.save().then(function(b){return i.set("status","pending_delivery"),i.save().then(function(b){var e,f,g;return g={hasSeen:!1,recipientUser:d,channel:"push",processed:!1,type:"AcceptedOffer",offerObject:a},e=Parse.Object.extend("Notification"),f=new e(g),f.save().then(function(b){var d;return d={offerId:a.id,offerStatus:a.get("status"),offerUpdatedAt:a.updatedAt,requestId:a.get("request").id,requestStatus:a.get("request").get("status")},c.success(d)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error("Failed to update offer status due to - "+a.message)})}),Parse.Cloud.define("getRequestForOffer",function(a,b){var c,d;return c=a.params.offerId,d=new Parse.Query("Offer"),d.equalTo("objectId",c),d.select("request"),d.include("request"),d.include("request.product"),d.first().then(function(a){var c,d,e,f;return e=a.get("request"),d=e.get("product"),c={name:d.get("name"),images:d.get("images"),mrp:d.get("mrp")},f={id:e.id,product:c,status:e.get("status"),address:e.get("address"),comments:e.get("comments"),createdAt:e.createdAt,updatedAt:e.updatedAt,offerCount:e.get("offerCount")},b.success(f)},function(a){return b.error(a)})}),Parse.Cloud.define("isOfferNotificationSeen",function(b,c){var d,e,f,g,h;return h=b.params.userId,f=b.params.requestId,g="Offer",e=new Parse.Query("Offer"),d=new Parse.Query("Request"),d.equalTo("objectId",f),e.matchesQuery("request",d),e.first().then(function(b){var d,e,g,i,j,k;return a.isEmpty(b)?(d=!0,k={requestId:f,offerId:"",hasSeen:d},c.success(k)):(i=b.id,j=new Parse.Query("Notification"),j.equalTo("type","Offer"),e=new Parse.Query("Offer"),e.equalTo("objectId",i),j.matchesQuery("offerObject",e),g=new Parse.Query(Parse.User),g.equalTo("objectId",h),j.matchesQuery("recipientUser",g),j.first().then(function(a){return d=a.get("hasSeen"),k={requestId:f,offerId:i,hasSeen:d},c.success(k)},function(a){return c.error("1"+a)}))},function(a){return c.error("2"+a)})}),Parse.Cloud.define("getAcceptedOfferCount",function(a,b){var c,d,e;return e=a.params.sellerId,d=new Parse.Query("Offer"),c=new Parse.Query(Parse.User),c.equalTo("objectId",e),d.matchesQuery("seller",c),d.equalTo("status","accepted"),d.count().then(function(a){return b.success(a)},function(a){return b.error(a)})}),Parse.Cloud.define("testDeliveryDate",function(a,b){var c,d,e,f,i,j,k,l,o,s,t,u;return d=a.params.claimedDelivery,j=a.params.offerAcceptedDate,s=a.params.sellerOffDays,t=a.params.sellerWorkTimings,f=g(d,j,s,t),k=f.offerAcceptedDate,e=f.deliveryDate,c=f.adjustedDeliveryDate,i=t[1],u=r(e).format("HH:mm:ss"),l=h(i,u),o={deliveryDate:r(e).format("dddd DD-MM-YYYY HH:mm:ss"),adjustedDeliveryDate:r(c).format("dddd DD-MM-YYYY HH:mm:ss"),acceptedDate:r(j).format("dddd DD-MM-YYYY HH:mm:ss"),offerAcceptedDate2:f.offerAcceptedDate,isDayValidWorking:p(e,s),isDayValidWorkTime:q(e,t),addedDateObject:r(m(e)).format("dddd DD-MM-YYYY HH:mm:ss"),isTimeBeforeWorkTime:n(e,t),pendingHours:l,timeOfDelivery:u,endtime:t[1]},b.success(o)}),g=function(a,c,d,e){var f,g,h,i,j,k;return h=a.value,i=a.unit,"day"===i&&(h=24*h),g=r(c).add("hours",h).toDate(),k="",f=b(c,g,k,d,e,h),j={offerAcceptedDate:c,deliveryDate:g,adjustedDeliveryDate:f}},b=function(c,d,e,f,g,i){var j,k,l,o,s,t,u,v,w,x,y,z;return p(d,f)?a.isEmpty(e)?q(d,g)?(console.log("step1"),n(c,g)?(console.log("step2"),x=g[0],x=x.split(":"),y={hours:parseInt(x[0]),minutes:parseInt(x[1]),seconds:parseInt(x[2])},k=d,j=c,w=r(j).hours(y.hours).minutes(y.minutes).seconds(y.seconds).toDate(),d=r(w).add("hours",i).toDate(),b(w,d,e,f,g,i)):(console.log("step3"),d)):(console.log("step4"),n(d,g)?(console.log("step5"),e=i,b(c,d,e,f,g,i)):(console.log("step6"),u=g[1],z=r(d).format("HH:mm:ss"),e=h(u,z),console.log("pending hours"+e),d=m(d),b(c,d,e,f,g,i))):(console.log("step7"),y=g[0],z=r(d).format("HH:mm:ss"),o=h(z,y),l=r(o,"hh:mm:ss").hours(),s=r(o,"hh:mm:ss").minutes(),t=r(o,"hh:mm:ss").seconds(),k=d,r(k).add("hours",l),r(k).add("minutes",s),v=r(k).add("seconds",t),d=v.toDate()):(console.log("step8"),d=m(d),d=b(c,d,e,f,g,i))},h=function(a,b){var c,d,e;return c=r(a,"hh:mm:ss"),d=r(b,"hh:mm:ss"),e=r(d.diff(c)).format("hh:mm:ss")},o=function(a,b){var c,d,e,f,g,h,i,j;return a=a.split(":"),i=parseInt(a[0]),j=parseInt(a[1]),f=b[0].split(":"),g=parseInt(f[0]),h=parseInt(f[1]),c=b[1].split(":"),d=parseInt(c[0]),e=parseInt(c[1]),i>g&&d>i?!0:i===g&&d>i?j>=h?!0:!1:i>g&&i===d&&e>=j?!0:!1},p=function(b,c){var d;return d=r(b).format("dddd"),a.indexOf(c,d)>-1?!1:!0},q=function(a,b){var c;return c=r(a).format("HH:mm:ss"),o(c,b)},m=function(a){var b;return b=r(a).add("days",1).toDate()},n=function(a,b){var c,d,e,f,g,h,i;return h=r(a).format("HH:mm:ss"),h=h.split(":"),i=parseInt(h[0]),f=b[0].split(":"),g=parseInt(f),c=b[1].split(":"),d=parseInt(c),g>i?(e={startTimeHour:g,timeHour:i},!0):!1},Parse.Cloud.job("productImport",function(b,c){var d,e,f,g,h,i;return d=Parse.Object.extend("ProductItem"),g=[],h=b.params.products,e=b.params.categoryId,f=b.params.priceRange,i=new Parse.Query("Category"),i.equalTo("objectId",e),i.include("filterable_attributes"),i.include("secondary_attributes"),i.include("filterable_attributes.filterAttribute"),i.include("primary_attributes"),i.select("filterable_attributes","primary_attributes","secondary_attributes"),i.first().then(function(b){var e,i,j;return j=0,a.isUndefined(b.get("filterable_attributes"))||(e=b.get("filterable_attributes").length),a.isUndefined(b.get("secondary_attributes"))||(i=b.get("secondary_attributes").length),j=e+i,a.each(h,function(c){var e,f,h,i,k,l,m,n,o,p,q,r,s,t;return k=a.keys(c.attrs).length,l=a.keys(c.text_attributes).length,t=k+l,a.isNull(c.name)||t!==j||a.isNull(c.brandId)?void 0:(s=new d,a.isNull(c.objectId)||(s.id=c.objectId),p=c.attrs,s.set("name",c.name),r=[],i=c.images,a.each(c.images,function(b){var c;return c=a.isNull(b.src)?{src:"https://placehold.it/350x150?text=Product"}:{src:b.src},r.push(c)}),s.set("images",r),s.set("model_number",String(c.model_number)),s.set("mrp",parseInt(c.mrp)),s.set("popularity",c.popularity),s.set("group",c.group),f={__type:"Pointer",className:"Brand",objectId:c.brandId},s.set("brand",f),s.set("category",b),a.isEmpty(c.text_attributes)||s.set("textAttributes",c.text_attributes),h=b.get("primary_attributes"),a.isUndefined(h)||(o=a.first(h),n=[],m={__type:"Pointer",className:"AttributeValues",objectId:p[o.id]},n.push(m),s.set("primaryAttributes",n)),q=b.get("filterable_attributes"),a.each(q,function(b){var c,d,e,f,g,h;return e=b.get("filterColumn"),d="filter"+e,g=b.get("filterAttribute").id,h=p[g],c=Parse.Object.extend("AttributeValues"),f=new c,f.id=h,a.isUndefined(h)?void 0:s.set(d,f)}),e=[],a.each(p,function(a){var b;return b={__type:"Pointer",className:"AttributeValues",objectId:a},e.push(b)}),s.set("attrs",e),g.push(s))}),Parse.Object.saveAll(g).then(function(a){return b.set("price_range",f),b.save().then(function(a){return c.success("Successfully added the products")},function(a){return c.error("Failed to add products due to - "+a.message)})},function(a){return c.error("Failed to add products due to - "+a.message)})},function(a){return c.error(a)})}),Parse.Cloud.define("getProducts",function(b,c){var d,e,f,g,h,i,j,k;return e=b.params.categoryId,j=b.params.selectedFilters,k=b.params.sortBy,d=b.params.ascending,i=parseInt(b.params.page),f=parseInt(b.params.displayLimit),g=new Parse.Query("Category"),g.equalTo("objectId",e),g.select("filterable_attributes"),g.select("supported_brands"),g.select("price_range"),g.include("filterable_attributes"),g.include("supported_brands"),h=g.first(),h.done(function(b){return function(b){var g,h,l,m,n,o,p,q,r,s,t,u,v,w,x;return o=b.get("filterable_attributes"),x=b.get("supported_brands"),t=b.get("price_range"),h=Parse.Object.extend("ProductItem"),q=new Parse.Query("Category"),q.equalTo("objectId",e),u=new Parse.Query("ProductItem"),u.matchesQuery("category",q),"all"!==j&&a.isObject(j)&&(n=Object.keys(j),a.contains(n,"brand")&&(l=j.brand,p=new Parse.Query("Brand"),p.equalTo("objectId",l),u.matchesQuery("brand",p)),a.contains(n,"price")&&(s=j.price,w=parseInt(s[0]),m=parseInt(s[1]),u.greaterThanOrEqualTo("mrp",w),u.lessThanOrEqualTo("mrp",m)),a.contains(n,"other_filters")&&(g=Parse.Object.extend("AttributeValues"),r=j.other_filters,a.each(r,function(b){var c;return g=Parse.Object.extend("AttributeValues"),c=[],c=a.map(b,function(a){var b;return b=new g,b.id=a,b}),u.containedIn("attrs",c)}))),u.select("images,name,mrp,brand,primaryAttributes"),u.include("brand"),u.include("primaryAttributes"),u.include("primaryAttributes.attribute"),u.limit(f),u.skip(i*f),d===!0?u.ascending(k):u.descending(k),v=u.find(),v.done(function(a){var b;return b={products:a,filters:o,supportedBrands:x,priceRange:t,sortableAttributes:["mrp","popularity"]},c.success(b)}),v.fail(function(a){return c.error(a.message)})}}(this)),h.fail(function(a){return function(a){return c.error(a.message)}}(this))}),Parse.Cloud.define("getProduct",function(a,b){var c,d,e;return d=a.params.productId,c=Parse.Object.extend("ProductItem"),e=new Parse.Query(c),e.equalTo("objectId",d),e.include("attrs"),e.include("brand"),e.include("attrs.attribute"),e.include("category"),e.include("primaryAttributes"),e.include("primaryAttributes.attribute"),e.first().then(function(a){return b.success(a)},function(a){return b.error(a)})}),Parse.Cloud.define("getProductsNew",function(b,d){var e,f,g,h,i,j,k;return f=b.params.categoryId,j=b.params.selectedFilters,k=b.params.sortBy,e=b.params.ascending,i=parseInt(b.params.page),
h=parseInt(b.params.displayLimit),g=new Parse.Query("Category"),g.equalTo("objectId",f),g.select("filterable_attributes"),g.select("supported_brands"),g.select("price_range"),g.include("filterable_attributes"),g.include("filterable_attributes.filterAttribute"),g.include("supported_brands"),g.first().then(function(b){var g,l,m;return l=b.get("filterable_attributes"),g=[],m=a.map(l,function(a){return c(a)}),Parse.Promise.when(m).then(function(){var c,l,m,n,o,p,q,r,s,t,u,v,w,x,y;return g=arguments,n=b.get("supported_brands"),y=a.map(n,function(a){var b;return null!==a?b={id:a.id,name:a.get("name")}:void 0}),u=b.get("price_range"),c=Parse.Object.extend("ProductItem"),q=new Parse.Query("Category"),q.equalTo("objectId",f),v=new Parse.Query("ProductItem"),v.matchesQuery("category",q),"all"!==j&&a.isObject(j)&&(p=Object.keys(j),a.contains(p,"brands")&&(m=j.brands,m.length>0&&(l=a.map(m,function(a){var b;return b=new Parse.Object("Brand"),b.id=a,b}),v.containedIn("brand",l))),a.contains(p,"price")&&(t=j.price,2===t.length&&(x=parseInt(t[0]),o=parseInt(t[1]),v.greaterThanOrEqualTo("mrp",x),v.lessThanOrEqualTo("mrp",o))),a.contains(p,"otherFilters")&&(s=j.otherFilters,a.isEmpty(s)||(r=a.keys(s),a.each(r,function(b){var c,d;return d=s[b],console.log(d),d.length>0?(c=a.map(d,function(a){var b;return b=new Parse.Object("AttributeValues"),b.id=a,b}),v.containedIn(b,c)):void 0})))),v.select("images,name,mrp,brand,primaryAttributes"),v.include("brand"),v.include("primaryAttributes"),v.include("primaryAttributes.attribute"),v.limit(h),v.skip(i*h),e===!0?v.ascending(k):v.descending(k),w=v.find().then(function(b){var c,e;return c=[],c=a.map(b,function(a){var b,c;return b={id:a.get("brand").id,name:a.get("brand").get("name")},c={objectId:a.id,name:a.get("name"),brand:b,images:a.get("images"),mrp:a.get("mrp"),primaryAttributes:a.get("primaryAttributes")}}),e={products:c,filters:g,supportedBrands:y,priceRange:u,sortableAttributes:["mrp","popularity"]},d.success(e)},function(a){return d.error(a)})},function(a){return d.error(a)})},function(a){return d.error(a)})}),c=function(b){return function(b){var c,d,e,f,g,h;return g=new Parse.Promise,e=b.get("filterColumn"),c=b.get("filterAttribute").id,d=b.get("filterAttribute").get("name"),h=new Parse.Query("AttributeValues"),f=new Parse.Query("Attributes"),f.equalTo("objectId",c),h.matchesQuery("attribute",f),h.find().then(function(b){var f,h;return f=a.map(b,function(a){var b;return b={id:a.id,name:a.get("value")}}),h={filterName:"filter"+e,attributeId:c,attributeName:d,values:f},g.resolve(h)},function(a){return g.reject(a)}),g}}(this),Parse.Cloud.define("makeRequest",function(b,c){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;return o=b.params.customerId,s=b.params.productId,k=b.params.categoryId,i=b.params.brandId,q=b.params.location,g=b.params.address,m=b.params.city,h=b.params.area,n=b.params.comments,u=b.params.status,e=Parse.Object.extend("Request"),b=new e,r=new Parse.GeoPoint(q),b.set("addressGeoPoint",r),b.set("address",g),b.set("status",u),b.set("city",m),b.set("area",h),b.set("comments",n),b.set("offerCount",0),p={__type:"Pointer",className:"_User",objectId:o},b.set("customerId",p),t={__type:"Pointer",className:"ProductItem",objectId:s},b.set("product",t),l={__type:"Pointer",className:"Category",objectId:k},b.set("category",l),j={__type:"Pointer",className:"Brand",objectId:i},b.set("brand",j),b.save().then(function(b){var e,g;return e=b.id,m=b.get("city"),h=b.get("area"),g=[],f(k,i,m,h).then(function(f){var g;return g=[],g=a.map(f,function(a){var b,c,f;return c=a.id,b=a.get("addressGeoPoint"),f=a.get("deliveryRadius"),d(c,b,f,e)}),Parse.Promise.when(g).then(function(){var d,f;return d=a.flatten(a.toArray(arguments)),f=[],a.each(d,function(a){var c,d,g,h,i;return d=a.sellerId,d?(i={__type:"Pointer",className:"_User",objectId:d},b={__type:"Pointer",className:"Request",objectId:e},h={hasSeen:!1,recipientUser:i,channel:"push",processed:!1,type:"Request",requestObject:b},c=Parse.Object.extend("Notification"),g=new c(h),f.push(g)):void 0}),Parse.Object.saveAll(f).then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getNewRequests",function(a,b){var c,d,e,f,g,h,j,k,l;return j=a.params.sellerId,f=a.params.city,c=a.params.area,k=a.params.sellerLocation,l=a.params.sellerRadius,e=a.params.categories,d=a.params.brands,g=a.params.productMrp,h={city:f,area:c,sellerLocation:k,sellerRadius:l,categories:e,brands:d,productMrp:g},i(j,h).then(function(a){return b.success(a)},function(a){return b.error(a)})}),Parse.Cloud.define("updateRequestStatus",function(b,c){var d,e,f,g,h,i;return g=b.params.requestId,h=b.params.status,e=b.params.failedDeliveryReason,i=["sent_for_delivery","failed_delivery","successful","cancelled"],f=a.indexOf(i,h),f>-1?(d=Parse.Object.extend("Request"),b=new d,b.id=g,b.set("status",h),"failed_delivery"===h&&b.set("failedDeliveryReason",e),b.save().then(function(b){var d,e,f,h,i;return f=b.get("status"),g=b.id,h=b.get("customerId"),console.log("requesting customer"),console.log(b),"cancelled"===f?(e=new Parse.Query("Notification"),d=new Parse.Query("Request"),d.equalTo("objectId",g),e.equalTo("type","Request"),e.matchesQuery("requestObject",d),e.include("recipientUser"),e.find().then(function(d){var e,f;return f=a.map(d,function(a){return a.get("recipientUser")}),e=[],a.each(f,function(a){var c,d,f;return f={hasSeen:!1,recipientUser:a,channel:"push",processed:!1,type:"CancelledRequest",requestObject:b},c=Parse.Object.extend("Notification"),d=new c(f),e.push(d)}),Parse.Object.saveAll(e).then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})):"sent_for_delivery"===f||"failed_delivery"===f||"successful"===f?b.fetch().then(function(a){var d,e,g,i;return h=b.get("customerId"),"sent_for_delivery"===f?i="SentForDeliveryRequest":"failed_delivery"===f?i="FailedDeliveryRequest":"successful"===f&&(i="SuccessfulRequest"),g={hasSeen:!1,recipientUser:h,channel:"push",processed:!1,type:i,requestObject:b},d=Parse.Object.extend("Notification"),e=new d(g),e.save().then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)}):(i={requestId:g,requestStatus:b.get("status")},c.success(i))},function(a){return c.error(a)})):c.error("Please enter a valid status")}),Parse.Cloud.define("getCustomerRequests",function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;return f=b.params.customerId,p=b.params.productId,o=parseInt(b.params.page),h=parseInt(b.params.displayLimit),u=b.params.requestType,v=b.params.selectedFilters,w=b.params.sortBy,g=b.params.descending,d=new Date,e=d.getTime(),i=24,q=new Date,x=e-60*i*60*1e3,q.setTime(x),"expired"===u?(t=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),t.matchesQuery("customerId",j),""!==p&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",p),t.matchesQuery("product",l)),t.equalTo("status","open"),t.lessThanOrEqualTo("createdAt",q)):"nonexpired"===u?(r=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),r.matchesQuery("customerId",j),""!==p&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",p),r.matchesQuery("product",l)),r.equalTo("status","open"),r.greaterThanOrEqualTo("createdAt",q),n=0===v.length?["cancelled","pending_delivery","failed_delivery","successful"]:a.without(v,"open"),s=new Parse.Query("Request"),k=new Parse.Query(Parse.User),k.equalTo("objectId",f),s.matchesQuery("customerId",k),""!==p&&(m=new Parse.Query("ProductItem"),m.equalTo("objectId",p),s.matchesQuery("product",m)),s.containedIn("status",n),t=a.indexOf(v,"open")>-1||0===v.length?Parse.Query.or(r,s):s):"all"===u&&(t=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),t.matchesQuery("customerId",j),""!==p&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",p),t.matchesQuery("product",l))),t.include("product"),g===!0?t.descending("updatedAt"):t.ascending("updatedAt"),t.limit(h),t.skip(o*h),t.find().then(function(b){var e;return e=a.map(b,function(a){var b,c,e,f,g,h;return d=new Date,b=a.createdAt,c=d.getTime()-b.getTime(),e=Math.floor(c/864e5),h=a.get("status"),e>=1&&"open"===h&&(h="expired"),g={name:a.get("product").get("name"),images:a.get("product").get("images"),mrp:a.get("product").get("mrp")},f={id:a.id,product:g,status:h,createdAt:a.createdAt,updatedAt:a.updatedAt,differenceInDays:e,address:a.get("address"),comments:a.get("comments"),offerCount:a.get("offerCount")}}),c.success(e)},function(a){return c.error(a)})}),Parse.Cloud.define("getSingleRequest",function(a,b){var c,d,e;return d=a.params.requestId,e={id:a.params.sellerId,geoPoint:a.params.sellerGeoPoint},c=new Parse.Query("Request"),c.equalTo("objectId",d),c.include("product"),c.include("category"),c.include("category.parent_category"),c.include("brand"),c.first().then(function(a){return l(a,e).then(function(a){return b.success(a)},function(a){return b.error(a)})},function(a){return b.error(a)})}),i=function(b,c){var d,e,f,g,h,i,j,k,m,n;return i=new Parse.Promise,g=c.city,d=c.area,j=c.sellerLocation,m=c.sellerRadius,f=c.categories,e=c.brands,h=c.productMrp,n="open",k=new Parse.Query(Parse.User),k.equalTo("objectId",b),k.include("supportedCategories"),k.include("supportedBrands"),k.first().then(function(c){var k,o,p,q,r,s,t,u,v,w;return o=Parse.Object.extend("Category"),k=Parse.Object.extend("Brand"),w=c.get("supportedCategories"),v=c.get("supportedBrands"),q=[],a.each(w,function(a){var b;return b={id:a.id,name:a.get("name")},q.push(b)}),p=[],a.each(v,function(a){var b;return b={id:a.id,name:a.get("name")},p.push(b)}),"default"===f?u=w:(u=[],a.each(f,function(a){var b;return b=new o,b.id=a,u.push(b)})),"default"===e?t=v:(t=[],a.each(e,function(a){var b;return b=new k,b.id=a,t.push(b)})),"default"===g&&(g=c.get("city")),"default"===d&&(d=c.get("area")),j="default"===j?c.get("addressGeoPoint"):j,m="default"===m?c.get("deliveryRadius"):parseInt(m),r=new Parse.Query(Parse.User),r.equalTo("objectId",b),s=new Parse.Query("Offer"),s.matchesQuery("seller",r),s.include("request"),s.include("request.product"),s.include("price"),s.descending("createdAt"),s.find().then(function(c){var e,f,k,o,r,s,v,w,x,y,z,A;return s={},x=[],a.each(c,function(a){var b,c,d,e,f;return f=a.get("request"),e=f.get("product"),d=e.id,c=a.get("price"),b=c.get("value"),s[d]=b,x.push(a.get("request").id)}),w=new Parse.Query("Request"),w.containedIn("category",u),w.containedIn("brand",t),w.equalTo("city",g),w.equalTo("area",d),w.equalTo("status",n),e=new Date,f=e.getTime(),o=24,v=new Date,A=f-60*o*60*1e3,v.setTime(A),w.greaterThanOrEqualTo("createdAt",v),y=new Parse.GeoPoint(j),w.withinKilometers("addressGeoPoint",y,m),w.notContainedIn("objectId",x),"default"!==h&&(z=parseFloat(h[0]),k=parseFloat(h[1]),r=new Parse.Query("ProductItem"),-1===z?r.lessThanOrEqualTo("mrp",k):-1===k?r.greaterThanOrEqualTo("mrp",z):(r.lessThanOrEqualTo("mrp",k),r.greaterThanOrEqualTo("mrp",z)),w.matchesQuery("product",r)),w.include("product"),w.include("category"),w.include("category.parent_category"),w.include("brand"),w.find().then(function(c){var e,f;return e=[],f={id:b,geoPoint:y},e=a.map(c,function(a){var b;return b=l(a,f,s)}),Parse.Promise.when(e).then(function(){var b,c;return b=a.flatten(a.toArray(arguments)),c={city:g,area:d,radius:m,location:j,requests:b,sellerCategories:q,sellerBrands:p},i.resolve(c)})},function(a){return i.reject(a)})},function(a){return i.reject(a)})},function(a){return i.reject(a)}),i},l=function(b,c,d){var e,f,g,h,i,j;return h=new Parse.Promise,j=c.id,i=c.geoPoint,e=b.get("product"),g=e.id,f={id:e.id,name:e.get("name"),mrp:e.get("mrp"),image:e.get("images"),model_number:e.get("model_number")},k(e).then(function(c){var e,k,l,m,n,o,p,q,r,s,t,u;return m=b.get("category"),l={id:m.id,name:m.get("name"),parent:m.get("parent_category").get("name")},k=b.get("brand"),e={id:k.id,name:k.get("name")},u=b.get("addressGeoPoint"),s=u.kilometersTo(i),q=a.keys(d),p=a.indexOf(q,g)>-1?d[g]:"",t={id:b.id,radius:s,product:f,category:l,brand:e,createdAt:b.createdAt,comments:b.get("comments"),status:b.get("status"),offerCount:b.get("offerCount"),lastOfferPrice:p,onlinePrice:c.online,platformPrice:c.platform},r=new Parse.Query("Notification"),o=new Parse.Query(Parse.User),o.equalTo("objectId",j),r.matchesQuery("recipientUser",o),r.equalTo("type","Request"),n=new Parse.Query("Request"),n.equalTo("objectId",b.id),r.matchesQuery("requestObject",n),r.first().then(function(c){var d,e,f,g;return a.isEmpty(c)?(d=Parse.Object.extend("Notification"),f=new d,g={__type:"Pointer",className:"_User",objectId:j},f.set("channel","push_copy"),f.set("type","Request"),f.set("processed",!0),f.set("requestObject",b),f.set("recipientUser",g),f.set("hasSeen",!1),f.save().then(function(a){return e={hasSeen:a.get("hasSeen")},t.notification=e,h.resolve(t)})):(e={hasSeen:c.get("hasSeen")},t.notification=e,h.resolve(t))},function(a){return h.reject(a)})},function(a){return h.reject(a)}),h},k=function(b){var c,d,f,g,h;return g=new Parse.Promise,f={},d=b.id,h=new Parse.Query("Price"),c=new Parse.Query("ProductItem"),c.equalTo("objectId",d),h.matchesQuery("product",c),h.equalTo("type","online_market_price"),h.first().then(function(c){return a.isEmpty(c)?f.online="":f.online=c.get("value"),e(b).then(function(a){return f.platform=a,g.resolve(f)},function(a){return g.reject(a)})},function(a){return g.reject(a)}),g},e=function(b){var c,d,e,f;return e=new Parse.Promise,f=new Parse.Query("Price"),d=b.id,c=new Parse.Query("ProductItem"),c.equalTo("objectId",d),f.matchesQuery("product",c),f.notEqualTo("type","online_market_price"),f.find().then(function(b){var c,d;return 0===b.length?c="":(d=[],a.each(b,function(a){return d.push(parseInt(a.get("value")))}),c=a.min(d)),e.resolve(c)},function(a){return e.reject(a)}),e},f=function(a,b,c,d){var e,f,g,h,i,j;return j=new Parse.Query(Parse.User),f=Parse.Object.extend("Category"),h=new f,h.id=a,e=Parse.Object.extend("Brand"),g=new e,g.id=b,j.equalTo("userType","seller"),j.equalTo("city",c),j.equalTo("area",d),j.equalTo("supportedCategories",h),j.equalTo("supportedBrands",g),i=new Parse.Promise,j.find().then(function(a){return 0===a.length?i.resolve():i.resolve(a)},function(a){return i.reject(a)}),i},d=function(a,b,c,d){var e,f;return f=new Parse.Query("Request"),f.equalTo("objectId",d),f.withinKilometers("addressGeoPoint",b,c),e=new Parse.Promise,f.find().then(function(c){var d;return 0===c.length?e.resolve():(d={sellerId:a,sellerGeoPoint:b},e.resolve(d))},function(a){return e.reject(a)}),e},Parse.Cloud.define("getLocationBasedSellers",function(b,c){var e,g,h,i,j,k,l,m,n,o,p;return m={latitude:b.params.location.latitude,longitude:b.params.location.longitude},j=b.params.categoryId,h=b.params.brandId,l=b.params.city,g=b.params.area,o="temporary",e=Parse.Object.extend("Request"),p=new e,n=new Parse.GeoPoint(m),p.set("addressGeoPoint",n),p.set("status",o),p.set("city",l),p.set("area",g),k={__type:"Pointer",className:"Category",objectId:j},p.set("category",k),i={__type:"Pointer",className:"Brand",objectId:h},p.set("brand",i),p.save().then(function(b){var e,i;return e=b.id,l=b.get("city"),g=b.get("area"),i=[],f(j,h,l,g).then(function(f){var g;return g=[],g=a.map(f,function(a){var b,c,f;return c=a.id,b=a.get("addressGeoPoint"),f=a.get("deliveryRadius"),d(c,b,f,e)}),Parse.Promise.when(g).then(function(){var d;return b.destroy(),d=a.flatten(a.toArray(arguments)),c.success(d)},function(a){return c.error(a)})})})}),Parse.Cloud.define("createTestSeller",function(b,c){var d,e,f,g,h,i,j;return d=new Parse.GeoPoint(b.params.addressLocation),j={username:b.params.username,password:b.params.password,email:b.params.email,addressGeoPoint:d,address:b.params.address,city:b.params.city,deliveryRadius:b.params.deliveryRadius},h=[],g=b.params.supportedCategories,a.each(g,function(a){var b;return b={__type:"Pointer",className:"Category",objectId:a},h.push(b)}),j.supportedCategories=h,f=[],e=b.params.supportedBrands,a.each(e,function(a){var b;return b={__type:"Pointer",className:"Brand",objectId:a},f.push(b)}),j.supportedBrands=f,j.userType="seller",i=new Parse.User(j),i.signUp().done(function(a){return function(a){return c.success(a)}}(this)).fail(function(a){return function(a){return c.error("Failed to create user "+a.message)}}(this))}),Parse.Cloud.define("updateSellerRating",function(a,b){var c,d,e;return e=a.params.sellerId,d=a.params.ratingInStars,c=new Parse.Query(Parse.User),c.equalTo("objectId",e),c.first().then(function(a){var c,f,g;return f=a.get("ratingSum"),c=a.get("ratingCount"),g=f+d,a.set("ratingSum",g),a.increment("ratingCount"),a.save().then(function(a){var c,d,f,g;return f=a.get("ratingSum"),d=a.get("ratingCount"),c=f/d,g={sellerId:e,avgRatings:c},b.success(g)})})}),Parse.Cloud.useMasterKey(),Parse.Cloud.define("sendSMSCode",function(b,c){var d,e,f,g,h,i,j;return g=b.params.phone,d=(Math.floor(9e5*Math.random())+1e5).toString(),e=b.params.displayName,j=b.params.userType,f=function(a){return c.error(a)},i=function(a,b){return b>3?c.success({attemptsExceeded:!0}):a.save({phone:g,verificationCode:d,attempts:b,displayName:e,userType:j}).then(function(){return c.success({code:d,attemptsExceeded:!1})},f)},h=new Parse.Query("SMSVerify"),h.equalTo("phone",g),h.find().then(function(b){var c,d,e;return a.isEmpty(b)?(c=Parse.Object.extend("SMSVerify"),e=new c,i(e,1)):(b=b[0],d=b.get("attempts"),i(b,d+1))},f)}),Parse.Cloud.afterSave("SMSVerify",function(a){var b,c,d;return b=a.object,c=b.get("phone"),d=b.get("verificationCode"),Parse.Cloud.httpRequest({url:"https://rest.nexmo.com/sms/json",params:{api_key:"e2f79907",api_secret:"88907392",from:"ShopOye",to:"91"+c,text:"Welcome to ShopOye. Your one time verification code is "+d}}).then(function(a){return console.log("SMS Sent: "+c)},function(a){return console.log("SMS Error")})}),Parse.Cloud.define("verifySMSCode",function(a,b){var c,d,e;return d=a.params.phone,c=a.params.code,e=new Parse.Query("SMSVerify"),e.equalTo("phone",d),e.find().then(function(a){var d,e;return a=a[0],d=a.get("verificationCode"),e=d===c?!0:!1,e&&a.destroy(),b.success({verified:e})},function(a){return b.error(a)})})}).call(this);