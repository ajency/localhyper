(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;Parse.Cloud.define("getAttribValueMapping",function(b,c){var d,e,f,g,h,i,j,k;return g=b.params.categoryId,i=b.params.filterableAttributes,k=b.params.secondaryAttributes,f=Parse.Object.extend("Category"),e=Parse.Object.extend("Attributes"),d=Parse.Object.extend("AttributeValues"),h=new Parse.Query("Category"),h.equalTo("objectId",g),i&&(h.include("filterable_attributes"),h.include("filterable_attributes.filterAttribute")),k&&h.include("secondary_attributes"),j=h.first(),j.done(function(b){return function(b){var d,e,f,g,h;return f=[],i&&(e=b.get("filterable_attributes"),e&&e.length>0&&(d=[],d=a.map(e,function(a){return a.get("filterAttribute")}),f=d)),k&&(h=b.get("secondary_attributes"),h&&h.length>0&&(f=a.union(d,h))),g=[],g=a.map(f,function(a){var b,c,d,e;return b=a.id,c=[],d=new Parse.Query("Attributes"),d.equalTo("objectId",b),e=new Parse.Query("AttributeValues"),e.matchesQuery("attribute",d),e.include("attribute"),e.limit(500),e.find()}),Parse.Promise.when(g).then(function(){var b,d,e,g;return e=a.flatten(a.toArray(arguments)),d=[],a.each(e,function(a){var b;return b={attributeId:a.get("attribute").id,attributeName:a.get("attribute").get("name"),group:a.get("attribute").get("group"),displayType:a.get("attribute").get("displayType"),valueId:a.id,value:a.get("value")},d.push(b)}),Parse.Promise.as(),b=a.map(f,function(a){return a={id:a.id,name:a.get("name"),type:a.get("type")}}),g={attributes:b,attributeValues:d},c.success(g)},function(a){return c.error(a)})}}(this))}),Parse.Cloud.define("attributeImport",function(b,c){var d,e,f,g,h,i,j;return d=Parse.Object.extend("Attributes"),e=[],f=b.params.attributes,g=b.params.categoryId,h=b.params.isFilterable,i=b.params.primaryAttributeObj,a.each(f,function(b){var c;return a.isNull(b.name)?void 0:(c=new d,a.isNull(b.objectId)||(c.id=b.objectId),c.set("name",b.name),c.set("group",b.group),a.isNull(b.unit)||c.set("unit",b.unit),b.hasOwnProperty("display_type")?c.set("display_type",b.display_type):c.set("display_type","checkbox"),b.hasOwnProperty("type")?c.set("type",b.type):c.set("type","select"),e.push(c))}),j=[],y(i).then(function(b){return Parse.Object.saveAll(e).then(function(d){var e,f,i,k;return a.isEmpty(b)||d.push(b),e=Parse.Object.extend("Category"),i=new e,i.id=g,f=Parse.Object.extend("ProductFilters"),h===!0?(k=new Parse.Query("ProductFilters"),k.equalTo("categoryId",g),k.find().then(function(e){return Parse.Object.destroyAll(e).then(function(e){var h,k,l;return h=1,l=1,k=[],a.each(d,function(a){var b,c;return c=a.get("type"),console.log(c),"range"===c?(b=new f,b.set("categoryId",g),b.set("filterColumn",l),b.set("filterAttribute",a),l++):(b=new f,b.set("categoryId",g),b.set("filterColumn",h),b.set("filterAttribute",a),h++),k.push(b)}),Parse.Object.saveAll(k).then(function(d){return i.set("filterable_attributes",d),a.isEmpty(b)||(j.push(b),i.set("primary_attributes",j)),i.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the attributes (with primary)"},c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error("1. error due to "+a)})},function(a){return c.error(a)})):(i.set("secondary_attributes",d),a.isEmpty(b)||(j.push(b),i.set("primary_attributes",j)),i.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the attributes (with primary)"},c.success(b)},function(a){return c.error(a)}))},function(a){return c.error("Failed to add/update attributes due to - "+a.message)})},function(a){return c.error("Failed to save/update primary attribute due to - "+a.message)})}),Parse.Cloud.define("attributeValueImport",function(b,c){var d,e,f,g;return d=Parse.Object.extend("AttributeValues"),e=[],f=b.params.attributeValues,g=b.params.categoryId,a.each(f,function(b){var c,f,g;return a.isNull(b.attributeId)||a.isNull(b.value)?void 0:(f=new d,a.isNull(b.objectId)||(f.id=b.objectId),g=String(b.value),f.set("value",g),c={__type:"Pointer",className:"Attributes",objectId:b.attributeId},f.set("attribute",c),e.push(f))}),Parse.Object.saveAll(e,{success:function(a){var b;return b={success:!0,message:"Successfully added/updated the attribute valuess"},c.success(b)},error:function(a){return c.error("Failed to add/update attributes due to - "+a.message)}})}),y=function(b){var c,d,e;return c=Parse.Object.extend("Attributes"),e=new Parse.Promise,a.isEmpty(b)||a.isNull(b.name)?(b={},e.resolve(b)):(d=new c,a.isNull(b.objectId)||(d.id=b.objectId),d.set("name",b.name),d.set("group",b.group),""!==b.unit&&d.set("unit",b.unit),b.hasOwnProperty("display_type")?d.set("display_type",b.display_type):d.set("display_type","checkbox"),b.hasOwnProperty("type")?d.set("type",b.type):d.set("type","select"),d.save().then(function(a){return e.resolve(a)},function(a){return e.reject(a)})),e},Parse.Cloud.define("getCategoryBasedBrands",function(a,b){var c,d;return c=a.params.categoryId,d=new Parse.Query("Category"),d.equalTo("objectId",c),d.include("supported_brands"),d.select("supported_brands"),d.first().then(function(a){return b.success(a)},function(a){return b.error("Error - "+a.message)})}),Parse.Cloud.define("brandImport",function(b,c){var d,e,f,g;return d=Parse.Object.extend("Brand"),f=[],e=b.params.brands,g=b.params.categoryId,a.each(e,function(b){var c,e;return a.isNull(b.name)?void 0:(c=new d,a.isNull(b.objectId)||(c.id=b.objectId),c.set("name",b.name),e=a.isNull(b.imageUrl)?{src:"https://placehold.it/350x150?text=Brand"}:{src:b.imageUrl},c.set("image",e),f.push(c))}),Parse.Object.saveAll(f,{success:function(a){var b,d;return b=Parse.Object.extend("Category"),d=new b,d.id=g,d.set("supported_brands",a),d.save().then(function(a){var b;return b={success:!0,message:"Successfully added/updated the brands"},c.success(b)},function(a){return c.error(a)})},error:function(a){return c.error(a)}})}),a=require("underscore.js"),v=require("cloud/moment"),A=function(a,b,c,d){var e,f;return b||(b="id"),c||(c="parent"),d||(d="children"),f=[],e={},a.forEach(function(a){e[a[b]]=a,a[d]=[]}),a.forEach(function(a){var b;null!==a[c]?(b=a[c],e[b][d].push(a)):f.push(a)}),f},Parse.Cloud.define("getCategories",function(b,c){var d,e,f,g;return g=b.params.sortBy,d=Parse.Object.extend("Category"),e=new Parse.Query(d),e.exists("name"),e.include("parent_category"),f=e.find(),f.done(function(b){return function(b){var d,e,f,h;return f=[],a.each(b,function(b){var c,d;return c={id:b.id,name:b.get("name"),sort_order:b.get("sort_order"),image:b.get("image"),description:b.get("description")},a.isObject(b.get("parent_category"))?(d=b.get("parent_category"),c.parent=d.id):c.parent=null,f.push(c)}),d=A(f,"id","parent","children"),e=i("category"),h={success:!0,data:a.sortBy(d,g),imageSizes:e},c.success(h)}}(this)),f.fail(function(a){return function(a){var b;return b={success:!1,errorCode:a.code,msg:a.msg},c.error(b)}}(this))}),Parse.Cloud.define("getCreditHistory",function(b,c){var d,e,f,g,h;return h=b.params.sellerId,d=b.params.displayLimit,f=b.params.page,e=new Parse.Query(Parse.User),e.equalTo("objectId",h),g=new Parse.Query("Transaction"),g.matchesQuery("seller",e),g.descending("createdAt"),g.include("offer"),g.include("offer.request"),g.include("offer.request.product"),g.limit(d),g.skip(f*d),g.find().then(function(b){var d;return 0===b.length?c.success(b):(d=[],a.each(b,function(b){var c,e,f,g,h,i,j;return a.isUndefined(b.get("offer"))?(c={},f={}):(e=b.get("offer"),h=e.get("request"),g=h.get("product"),c={id:e.id,status:e.get("status"),createdAt:e.createdAt,updatedAt:e.updatedAt},f={name:g.get("name"),model_number:g.get("model_number")}),i=a.isUndefined(b.get("towards"))?"":b.get("towards"),j={id:b.id,createdAt:b.createdAt,transactionType:b.get("transactionType"),transactionTowards:i,creditCount:b.get("creditCount"),offer:c,product:f},d.push(j)}),c.success(d))},function(a){return c.error(a)})}),Parse.Cloud.define("addCredits",function(a,b){var c,d,e;return e=a.params.sellerId,c=parseInt(a.params.newAddedCredits),d=new Parse.Query(Parse.User),d.equalTo("objectId",e),d.first().then(function(a){var d,e;return d=Parse.Object.extend("Transaction"),e=new d,e.set("seller",a),e.set("transactionType","add"),e.set("creditCount",c),e.save().then(function(d){var e,f;return e=a.get("addedCredit"),f=e+c,a.set("addedCredit",f),a.save().then(function(a){var c;return c={sellerId:a.id,addedCredit:a.get("addedCredit"),subtractedCredit:a.get("subtractedCredit")},b.success(c)},function(a){return b.error(a)})})},function(a){return b.error(a)})}),Parse.Cloud.define("testDeliveryDate",function(a,b){var c,d,e,f,i,j,k,l,m,n,o,p;return d=a.params.claimedDelivery,j=a.params.offerAcceptedDate,n=a.params.sellerOffDays,o=a.params.sellerWorkTimings,f=g(d,j,n,o),k=f.offerAcceptedDate,e=f.deliveryDate,c=f.adjustedDeliveryDate,i=o[1],p=v(e).format("HH:mm:ss"),l=h(i,p),m={moment:v(),deliveryDate:v(e).format("dddd DD-MM-YYYY HH:mm:ss"),adjustedDeliveryDate:v(c).format("dddd DD-MM-YYYY HH:mm:ss"),acceptedDate:v(j).format("dddd DD-MM-YYYY HH:mm:ss"),offerAcceptedDate2:f.offerAcceptedDate,isDayValidWorking:t(e,n),isDayValidWorkTime:u(e,o),addedDateObject:v(q(e)).format("dddd DD-MM-YYYY HH:mm:ss"),isTimeBeforeWorkTime:r(e,o),pendingHours:l,timeOfDelivery:p,endtime:o[1]},b.success(m)}),g=function(a,c,d,e){var f,g,h,i,j,k;return h=a.value,i=a.unit,"day"===i&&(h=24*h),g=v(c).add(h,"hours").toDate(),k="",f=b(c,g,k,d,e,h),j={offerAcceptedDate:c,deliveryDate:g,adjustedDeliveryDate:f}},b=function(c,d,e,f,g,i){var j,k,l,m,n,o,p,s,w,x,y,z;return t(d,f)?a.isEmpty(e)?u(d,g)?(console.log("step1"),r(c,g)?(console.log("step2"),x=g[0],x=x.split(":"),y={hours:parseInt(x[0]),minutes:parseInt(x[1]),seconds:parseInt(x[2])},k=d,j=c,w=v(j).hours(y.hours).minutes(y.minutes).seconds(y.seconds).toDate(),d=v(w).add(i,"hours").toDate(),b(w,d,e,f,g,i)):(console.log("step3"),d)):(console.log("step4"),r(d,g)?(console.log("step5"),e=i,b(c,d,e,f,g,i)):(console.log("step6"),p=g[1],z=v(d).format("HH:mm:ss"),e=h(p,z),console.log("pending hours"+e),d=q(d),b(c,d,e,f,g,i))):(console.log("step7"),y=g[0],z=v(d).format("HH:mm:ss"),m=h(z,y),l=v(m,"hh:mm:ss").hours(),n=v(m,"hh:mm:ss").minutes(),o=v(m,"hh:mm:ss").seconds(),k=d,v(k).add(l,"hours"),v(k).add(n,"minutes"),s=v(k).add(o,"seconds"),d=s.toDate()):(console.log("step8"),d=q(d),d=b(c,d,e,f,g,i))},h=function(a,b){var c,d,e;return c=v(a,"hh:mm:ss"),d=v(b,"hh:mm:ss"),e=v(d.diff(c)).format("hh:mm:ss")},s=function(a,b){var c,d,e,f,g,h,i,j;return a=a.split(":"),i=parseInt(a[0]),j=parseInt(a[1]),f=b[0].split(":"),g=parseInt(f[0]),h=parseInt(f[1]),c=b[1].split(":"),d=parseInt(c[0]),e=parseInt(c[1]),i>g&&d>i?!0:i===g&&d>i?j>=h?!0:!1:i>g&&i===d&&e>=j?!0:!1},t=function(b,c){var d;return d=v(b).format("dddd"),a.indexOf(c,d)>-1?!1:!0},u=function(a,b){var c;return c=v(a).format("HH:mm:ss"),s(c,b)},q=function(a){var b;return b=v(a).add(1,"days").toDate()},r=function(a,b){var c,d,e,f,g,h,i;return h=v(a).format("HH:mm:ss"),h=h.split(":"),i=parseInt(h[0]),f=b[0].split(":"),g=parseInt(f),c=b[1].split(":"),d=parseInt(c),g>i?(e={startTimeHour:g,timeHour:i},!0):!1},x=function(a){var b,c,d;return c=new Parse.Promise,d=new Parse.Query("Offer"),b=new Parse.Query("Request"),b.equalTo("objectId",a),d.matchesQuery("request",b),d.count().then(function(b){var d,e;return d=Parse.Object.extend("Request"),e=new d,e.id=a,e.set("offerCount",b),e.save().then(function(a){return c.resolve(a)},function(a){return c.reject(a)})},function(a){return response.error(a)}),c},Parse.Cloud.define("updateRequestOfferCount",function(b,c){var d,e,f;return d=b.params.customerId,f=new Parse.Query("Request"),e=new Parse.Query(Parse.User),e.equalTo("objectId",d),f.matchesQuery("customerId",e),f.find().then(function(b){var d;return d=[],d=a.map(b,function(a){return x(a.id)}),Parse.Promise.when(d).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("sendMail",function(a,b){var c,d,e,f,g,h,i,j;return h=a.params.productName,e=a.params.category,d=a.params.brand,g=a.params.description,f=a.params.comments,j=a.params.userType,i="<b> You have received a suggestion for a product from "+j+"</b> <br>",i+="<p>Product Name:"+h+"<br> Category:"+e+"<br> Brand: "+d,null!==g&&(i+="<br> Description: "+g),null!==f&&(i+="<br> Comments: "+f),i+="</p>",c=require("mandrill"),c.initialize("PhWvFeH8FEiav4blIeNfXA"),c.sendEmail({message:{html:"<p>"+i+"</p>",text:i,subject:"Product suggestions",from_email:"ShopeoyeParse@cloudcode.com",from_name:"Shopeoye",to:[{email:"support@shopoye.co.in",name:"Shopoye"},{email:"info@shopoye.co.in",type:"cc"},{email:"ashika@ajency.in ",type:"cc"}]},async:!0},{success:function(a){return b.success("Mail Sent")},error:function(a){return b.error("err")}})}),k=function(b,c,d){var e,f;return f=new Parse.Promise,e=new Parse.Query(Parse.Installation),e.equalTo("installationId",c),e.find().then(function(e){var g,h,i;return g=a.isEmpty(e)?"unknown":e[0].get("deviceType"),i="android"===g.toLowerCase()?{header:d.title,message:d.alert,data:d.notificationData}:{title:d.title,alert:d.alert,data:d.notificationData,badge:"Increment"},h={pushData:i,installationId:c,notificationId:b},f.resolve(h)},function(a){return f.reject(a)}),f},w=function(a,b,c){var d,e;return d=new Parse.Promise,e=new Parse.Query(Parse.Installation),e.equalTo("installationId",a),Parse.Push.send({where:e,data:b}).then(function(){var a,b;return a=Parse.Object.extend("Notification"),b=new Parse.Query(a),b.equalTo("objectId",c),b.first().then(function(a){return a.set("processed",!0),a.save().then(function(a){return d.resolve(a)},function(a){return d.reject(a)})},function(a){return d.reject(a)})},function(a){return d.reject(a)}),d},Parse.Cloud.job("processNotifications",function(b,c){var d;return d=new Parse.Query("Notification"),d.equalTo("processed",!1),d.include("recipientUser"),d.include("requestObject"),d.include("requestObject.product"),d.include("offerObject"),d.include("offerObject.request"),d.include("offerObject.request.product"),d.find().then(function(b){var d,e,f;return e=[],f="Shopoye Seller",d="Shopoye",a.each(b,function(a){var b,c,g,h,i,j,l,m,n,o,p,q;switch(b=a.get("channel"),n=a.get("recipientUser"),g=a.id,q=n.get("installationId"),p=a.get("type"),"Request"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=f,c="New request for "+l,j={id:i.id,type:"new_request",imageUrl:"https://s3-ap-southeast-1.amazonaws.com/aj-shopoye/images-product/LG%2BLWA5BP1A%2B1.5%2BTon%2B1%2BStar%2BWindow%2BAC(White)-800x480.jpg"}):"Offer"===p?(i=a.get("offerObject"),l=a.get("offerObject").get("request").get("product").get("name"),o=d,c="New offer for "+l,j={id:i.id,type:"new_offer"}):"AcceptedOffer"===p?(i=a.get("offerObject"),l=a.get("offerObject").get("request").get("product").get("name"),o=f,c="Offer accepted for "+l,j={id:i.id,type:"accepted_offer"}):"CancelledRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=f,c="Request cancelled for "+l,j={id:i.id,type:"cancelled_request"}):"SentForDeliveryRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c=l+" is sent for delivery",j={id:i.id,type:"request_delivery_changed",requestStatus:i.get("status")}):"FailedDeliveryRequest"===p?(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c="Delivery failed for "+l,j={id:i.id,type:"request_delivery_changed",requestStatus:i.get("status")}):"SuccessfulRequest"===p&&(i=a.get("requestObject"),l=a.get("requestObject").get("product").get("name"),o=d,c="Delivery successful for "+l,j={id:i.id,type:"request_delivery_changed",requestStatus:i.get("status")}),b){case"push":return m={title:o,alert:c,notificationData:j},h=k(g,q,m),e.push(h);case"sms":return console.log("send sms")}}),Parse.Promise.when(e).then(function(){var b,d;return b=a.flatten(a.toArray(arguments)),d=[],a.each(b,function(a){var b,c,e;return b=a.installationId,c=a.notificationId,e=w(b,a.pushData,c),d.push(e)}),Parse.Promise.when(d).then(function(){return c.success("Processed")},function(a){return c.error(a)})},function(a){return c.error("Error")})},function(a){return c.error(a)})}),Parse.Cloud.define("getUnseenNotifications",function(b,c){var d,e,f,g;return g=b.params.userId,f=b.params.type,e=new Parse.Query("Notification"),e.equalTo("hasSeen",!1),d=new Parse.Query(Parse.User),d.equalTo("objectId",g),e.matchesQuery("recipientUser",d),e.equalTo("type",f),e.include("requestObject"),e.select("requestObject"),e.select("offerObject"),e.find().then(function(b){var d;return d=[],"Request"===f?a.each(b,function(a){var b,c,e,f,g,h,i;return h=a.get("requestObject"),c=new Date,b=h.createdAt,e=c.getTime()-b.getTime(),f=Math.floor(e/864e5),i=h.get("status"),f>=1&&"open"===i&&(i="expired"),"open"===i?(g=a.get("requestObject").id,d.push(g)):void 0}):"Offer"===f&&(d=a.map(b,function(a){var b;return b=a.get("offerObject").id})),c.success(d)},function(a){return c.error(a)})}),Parse.Cloud.define("updateNotificationStatus",function(b,c){var d,e,f,g,h,i,j;return g=b.params.notificationType,h=b.params.notificationTypeId,i=b.params.recipientId,d=b.params.hasSeen,f=new Parse.Query("Notification"),f.equalTo("type",g),j={__type:"Pointer",className:"_User",objectId:i},f.equalTo("recipientUser",j),"Request"===g?(e=new Parse.Query("Request"),e.equalTo("objectId",h),f.matchesQuery("requestObject",e)):"Offer"===g&&(e=new Parse.Query("Offer"),a.isArray(h)?e.containedIn("objectId",h):a.isString(h)&&e.equalTo("objectId",h),f.matchesQuery("offerObject",e)),f.find().then(function(b){var e;return e=a.map(b,function(a){return a.set("hasSeen",d),a.save()}),Parse.Promise.when(e).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getNewOffers",function(b,c){var d,e,f,g,h;return g=b.params.productId,d=b.params.customerId,f=new Parse.Query("ProductItem"),f.equalTo("objectId",g),e=new Parse.Query(Parse.User),e.equalTo("objectId",d),h=new Parse.Query("Request"),h.matchesQuery("product",f),h.matchesQuery("customerId",e),h.first().then(function(b){var d,g,h,i,j,k,l,m;return a.isEmpty(b)?(i=!1,l={activeRequest:{},offers:[],moreRequests:i},c.success(l)):(i=!0,k=new Parse.Query("Request"),k.matchesQuery("product",f),k.matchesQuery("customerId",e),d=new Date,g=d.getTime(),h=24,j=new Date,m=g-60*h*60*1e3,j.setTime(m),k.greaterThanOrEqualTo("createdAt",j),k.descending("createdAt"),k.find().then(function(a){var b,d,e,f;return 0===a.length?(l={activeRequest:{},offers:[],moreRequests:i},c.success(l)):(d=a[0],f=d.get("status"),"open"===f?(e=new Parse.Query("Offer"),b=new Parse.Query("Request"),b.equalTo("objectId",d.id),e.matchesQuery("request",b),e.equalTo("status","open"),e.find().then(function(a){return l={activeRequest:d,offers:a,moreRequests:i},c.success(l)},function(a){return c.error(a)})):(l={activeRequest:{},offers:[],moreRequests:i},c.success(l)))},function(a){return c.error(a)}))},function(a){return c.error(a)})}),Parse.Cloud.define("makeOffer",function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;return n=b.params.requestId,p=b.params.sellerId,m=parseInt(b.params.priceValue),k=b.params.deliveryTime,j=b.params.comments,q=b.params.status,i=a.has(b.params,"autoBid")?b.params.autoBid:!1,l=1,h=5,f=Parse.Object.extend("Price"),e=Parse.Object.extend("Offer"),g=Parse.Object.extend("Request"),d=Parse.Object.extend("Notification"),o=new Parse.Query("Request"),o.equalTo("objectId",n),o.first().then(function(a){var b,h,o,r,s,t;return s=a.get("customerId"),b=a.createdAt,r=a.get("addressGeoPoint"),h=new f,h.set("source","seller"),t=new Parse.User,t.id=p,h.set("seller",t),h.set("type","open_offer"),h.set("value",m),o=a.get("product"),h.set("product",o),h.save().then(function(b){var f,h;return f=new e,h=new g,h.id=n,f.set("seller",t),f.set("request",h),f.set("price",b),f.set("status",q),f.set("deliveryTime",k),f.set("comments",j),f.set("autoBid",i),f.set("requestDate",a.createdAt),f.set("offerPrice",m),f.set("requestGeoPoint",a.get("addressGeoPoint")),f.save().then(function(a){var b,e;return b=Parse.Object.extend("Transaction"),e=new b,e.set("seller",t),e.set("transactionType","minus"),e.set("creditCount",l),e.set("towards","make_offer"),e.set("offer",a),e.save().then(function(b){return t.fetch().then(function(e){var f,g;return g=e.get("subtractedCredit"),f=g+b.get("creditCount"),t.set("subtractedCredit",f),e.save().then(function(b){var e;return e=new d,e.set("hasSeen",!1),e.set("recipientUser",s),e.set("channel","push"),e.set("processed",!1),e.set("type","Offer"),e.set("offerObject",a),e.save().then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getSellerOffers",function(b,c){var d,e,f,g,h,j,k,l,m,n,o,p,q,r;return p=b.params.sellerId,o=b.params.sellerGeoPoint,l=parseInt(b.params.page),h=parseInt(b.params.displayLimit),d=b.params.acceptedOffers,n=b.params.selectedFilters,q=b.params.sortBy,g=b.params.descending,k=new Parse.Query(Parse.User),k.equalTo("objectId",p),m=new Parse.Query("Offer"),m.matchesQuery("seller",k),d===!0?(f=["accepted"],e=0===n.length?["pending_delivery","sent_for_delivery","failed_delivery","successful"]:n,j=new Parse.Query("Request"),j.containedIn("status",e),m.matchesQuery("request",j),m.containedIn("status",f)):(f=0===n.length?["open","unaccepted"]:a.without(n,"expired"),m.containedIn("status",f)),m.limit(h),m.skip(l*h),"distance"===q?m.near("requestGeoPoint",o):(r="offerPrice"===q?"offerPrice":"expiryTime"===q?"requestDate":"updatedAt"===q?"updatedAt":"deliveryDate"===q?"deliveryDate":"updatedAt",g===!0?m.descending(r):m.ascending(r)),m.include("price"),m.include("request"),m.include("seller"),m.include("price"),m.include("request.product"),m.include("request.brand"),m.include("request.category"),m.include("request.category.parent_category"),m.find().then(function(d){var e,f,g;return g=[],a.each(d,function(c){var d,e,f,h,i,j,k,l,m,n,p,q,r,s,t,u,v,w;return s=c.get("request"),q=s.get("product"),e=s.get("brand"),h=s.get("category"),u=c.get("seller"),n=c.get("price"),p={objectId:q.id,name:q.get("name"),mrp:q.get("mrp"),modelNumber:q.get("model_number"),images:q.get("images")},d={objectId:e.id,name:e.get("name")},f={objectId:h.id,name:h.get("name"),parentCategory:h.get("parent_category").get("name")},o=u.get("addressGeoPoint"),r=s.get("addressGeoPoint"),w=r.kilometersTo(o),j=new Date,i=s.createdAt,k=j.getTime()-i.getTime(),l=Math.floor(k/864e5),t=s.get("status"),l>=1&&"open"===t&&(t="expired"),m=s.get("failedDeliveryReason"),a.isNull(m)&&(m=""),b={id:s.id,address:s.get("address"),status:t,differenceInDays:l,offerCount:s.get("offerCount"),comments:s.get("comments"),failedDeliveryReason:m,createdAt:s.createdAt},v={id:c.id,product:p,brand:d,category:f,request:b,distanceFromCustomer:w,offerPrice:n.get("value"),offerStatus:c.get("status"),offerDeliveryTime:c.get("deliveryTime"),offerDeliveryDate:c.get("deliveryDate"),offerDeliveryDate:c.get("deliveryDate"),offerComments:c.get("comments"),createdAt:c.createdAt,updatedAt:c.updatedAt},g.push(v)}),e=i("product"),f={sellerOffers:g,imageSizes:e},c.success(f)},function(a){return c.error(a)})}),Parse.Cloud.afterSave("Offer",function(a){var b,c,d,e;return c=a.object,c.existed()?void 0:(e=c.get("request").id,b=Parse.Object.extend("Request"),d=new Parse.Query(b),d.get(e).then(function(a){return a.increment("offerCount"),a.save()},function(a){return console.log("Got an error "+a.code+" : "+a.message)}))}),Parse.Cloud.define("getRequestOffers",function(b,c){var d,e,f,g;return g=b.params.requestId,d=a.has(b.params,"customerId")?b.params.customerId:null,f=new Parse.Query("Offer"),e=new Parse.Query("Request"),e.equalTo("objectId",g),f.matchesQuery("request",e),f.include("price"),f.include("request"),f.include("request.product"),f.include("seller"),f.find().then(function(b){var e;return e=[],e=a.map(b,function(a){return l(a,d)}),Parse.Promise.when(e).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("acceptOffer",function(b,c){var d,e,f,g,h,i,j;return g=b.params.offerId,j=b.params.unacceptedOfferIds,e=5,d=Parse.Object.extend("Offer"),i=[],f={id:g,status:"accepted"},i.push(f),j.length>0&&a.each(j,function(a){var b;return b={id:a,status:"unaccepted"},i.push(b)}),h=[],a.each(i,function(a){var b;return b=new d,b.id=a.id,b.set("status",a.status),h.push(b)}),Parse.Object.saveAll(h).then(function(a){var b;return b=new Parse.Query("Offer"),b.equalTo("objectId",g),b.include("request"),b.include("seller"),b.include("price"),b.first().then(function(a){var b,d,f;return d=a.get("seller"),b=Parse.Object.extend("Transaction"),f=new b,f.set("seller",d),f.set("transactionType","minus"),f.set("creditCount",e),f.set("towards","accept_offer"),f.set("offer",a),f.save().then(function(b){var e,f;return f=d.get("subtractedCredit"),e=f+b.get("creditCount"),d.set("subtractedCredit",e),d.save().then(function(b){var e,f,g,h,i,j,k;return i=a.get("request"),e=a.get("deliveryTime"),g=parseInt(e.value),h=a.updatedAt,j=["Sunday","Monday"],k=["9:00:00","18:00:00"],f=v(h).add(g,"hours").toDate(),a.set("deliveryDate",f),a.save().then(function(b){return i.set("status","pending_delivery"),i.save().then(function(b){var e;return e=a.get("price"),e.set("type","accepted_offer"),e.save().then(function(b){var e,f,g;return g={hasSeen:!1,recipientUser:d,channel:"push",processed:!1,type:"AcceptedOffer",offerObject:a},e=Parse.Object.extend("Notification"),f=new e(g),f.save().then(function(b){var d;return d={offerId:a.id,offerStatus:a.get("status"),offerUpdatedAt:a.updatedAt,requestId:a.get("request").id,requestStatus:a.get("request").get("status")},c.success(d)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error("Failed to update offer status due to - "+a.message)})}),Parse.Cloud.define("isOfferNotificationSeen",function(b,c){var d,e,f,g,h;return h=b.params.userId,f=b.params.requestId,g="Offer",e=new Parse.Query("Offer"),d=new Parse.Query("Request"),d.equalTo("objectId",f),e.matchesQuery("request",d),e.first().then(function(b){var d,e,g,i,j,k;return a.isEmpty(b)?(d=!0,k={requestId:f,offerId:"",hasSeen:d},c.success(k)):(i=b.id,j=new Parse.Query("Notification"),j.equalTo("type","Offer"),e=new Parse.Query("Offer"),e.equalTo("objectId",i),j.matchesQuery("offerObject",e),g=new Parse.Query(Parse.User),g.equalTo("objectId",h),j.matchesQuery("recipientUser",g),j.first().then(function(a){return d=a.get("hasSeen"),k={requestId:f,offerId:i,hasSeen:d},c.success(k)},function(a){return c.error("1"+a)}))},function(a){return c.error("2"+a)})}),Parse.Cloud.define("getAcceptedOfferCount",function(a,b){var c,d,e;return e=a.params.sellerId,d=new Parse.Query("Offer"),c=new Parse.Query(Parse.User),c.equalTo("objectId",e),d.matchesQuery("seller",c),d.equalTo("status","accepted"),d.count().then(function(a){return b.success(a)},function(a){return b.error(a)})}),l=function(b,c){var d,e,f,g,h,i,j,k,l;return i=new Parse.Promise,h=b.get("request").get("product"),g={name:h.get("name"),images:h.get("images")},l=b.get("seller"),k={id:l.id,displayName:l.get("displayName"),businessName:l.get("businessName"),address:l.get("address"),city:l.get("city"),phoneNumber:l.get("username")},a.isNull(c)?(d={code:"no_customer_id",message:"No customer id sent"},i.reject(d)):(j=new Parse.Query("Ratings"),e=new Parse.Query(Parse.User),e.equalTo("objectId",c),j.matchesQuery("ratingBy",e),f=new Parse.Query(Parse.User),f.equalTo("objectId",l.id),j.matchesQuery("ratingFor",f),j.equalTo("ratingForType","seller"),j.first().then(function(d){var e,h,j,l,m,n;return j=a.isEmpty(d)?!1:!0,m=b.get("price"),e=a.isUndefined(b.get("deliveryDate"))?"":b.get("deliveryDate"),k.isSellerRated=j,l={id:b.id,product:g,seller:k,price:m.get("value"),comments:b.get("comments"),deliveryTime:b.get("deliveryTime"),status:b.get("status"),createdAt:b.createdAt,updatedAt:b.updatedAt,deliveryDate:e},n=new Parse.Query("Notification"),f=new Parse.Query(Parse.User),f.equalTo("objectId",c),n.matchesQuery("recipientUser",f),n.equalTo("type","Offer"),h=new Parse.Query("Offer"),h.equalTo("objectId",b.id),n.matchesQuery("offerObject",h),n.first().then(function(a){var b;return b={id:a.id,hasSeen:a.get("hasSeen")},l.notification=b,i.resolve(l)},function(a){return i.resolve(a)})},function(a){return i.reject(a)})),i},Parse.Cloud.define("productImport",function(b,c){var d,e,f,g,h,i,j;return d=Parse.Object.extend("ProductItem"),h=[],f=0,i=b.params.products,e=b.params.categoryId,g=b.params.priceRange,j=new Parse.Query("Category"),j.equalTo("objectId",e),j.include("filterable_attributes"),j.include("secondary_attributes"),j.include("filterable_attributes.filterAttribute"),j.include("primary_attributes"),j.select("filterable_attributes","primary_attributes","secondary_attributes"),j.first().then(function(b){var e,j,k;return k=0,a.isUndefined(b.get("filterable_attributes"))||(e=b.get("filterable_attributes").length),a.isUndefined(b.get("secondary_attributes"))||(j=b.get("secondary_attributes").length),k=e+j,a.each(i,function(c){var e,g,i,j,l,m,n,o,p,q,r,s,t,u;return l=a.keys(c.attrs).length,m=a.keys(c.text_attributes).length,u=l+m,a.isNull(c.name)||u!==k||a.isNull(c.brandId)?void 0:(f++,t=new d,a.isNull(c.objectId)||(t.id=c.objectId),q=c.attrs,t.set("name",c.name),s=[],j=c.images,a.each(c.images,function(a){var b;return b={src:a.src},s.push(b)}),t.set("images",s),t.set("model_number",String(c.model_number)),t.set("mrp",parseInt(c.mrp)),t.set("popularity",parseInt(c.popularity)),t.set("group",c.group),g={__type:"Pointer",className:"Brand",objectId:c.brandId},t.set("brand",g),t.set("category",b),a.isEmpty(c.text_attributes)||t.set("textAttributes",c.text_attributes),i=b.get("primary_attributes"),a.isUndefined(i)||(p=a.first(i),o=[],n={__type:"Pointer",className:"AttributeValues",objectId:q[p.id].id},o.push(n),t.set("primaryAttributes",o)),r=b.get("filterable_attributes"),a.each(r,function(b){var c,d,e,f,g,h,i,j;if(e=b.get("filterColumn"),i=b.get("filterAttribute").get("type"),h="range"===i?"range":"filter",d=h+(""+e),g=b.get("filterAttribute").id,"range"===i){if(j=q[g].value,!a.isUndefined(j))return t.set(d,j)}else if(j=q[g].id,c=Parse.Object.extend("AttributeValues"),f=new c,f.id=j,!a.isUndefined(j))return t.set(d,f)}),e=[],a.each(q,function(a){var b;return b={__type:"Pointer",className:"AttributeValues",objectId:a.id},e.push(b)}),t.set("attrs",e),h.push(t))}),Parse.Object.saveAll(h).then(function(a){return b.set("price_range",g),b.save().then(function(a){return c.success("Successfully added "+f+" products")},function(a){return c.error("Failed to add products due to - "+a.message)})},function(a){return c.error("Failed to add products due to - "+a.message)})},function(a){return c.error(a)})}),Parse.Cloud.define("getProducts",function(b,d){var e,f,g,h,j,k,l,m;return f=b.params.categoryId,l=b.params.selectedFilters,m=b.params.sortBy,e=b.params.ascending,j=parseInt(b.params.page),h=parseInt(b.params.displayLimit),k=a.has(b.params,"searchKeywords")?b.params.searchKeywords:"all",g=new Parse.Query("Category"),g.equalTo("objectId",f),g.select("filterable_attributes"),g.select("supported_brands"),g.select("price_range"),g.include("filterable_attributes"),g.include("filterable_attributes.filterAttribute"),g.include("supported_brands"),g.first().then(function(b){var g,n,o;return n=b.get("filterable_attributes"),g=[],o=a.map(n,function(a){return c(a)}),Parse.Promise.when(o).then(function(){var c,n,o,p,q,r,s,t,u,v,w,x,y,z,A;return g=arguments,p=b.get("supported_brands"),A=a.map(p,function(a){
var b;return null!==a?b={id:a.id,name:a.get("name")}:void 0}),w=b.get("price_range"),c=Parse.Object.extend("ProductItem"),s=new Parse.Query("Category"),s.equalTo("objectId",f),x=new Parse.Query("ProductItem"),x.matchesQuery("category",s),"all"!==k&&k.length>0&&x.containsAll("searchKeywords",k),"all"!==l&&a.isObject(l)&&(r=Object.keys(l),a.contains(r,"brands")&&(o=l.brands,o.length>0&&(n=a.map(o,function(a){var b;return b=new Parse.Object("Brand"),b.id=a,b}),x.containedIn("brand",n))),a.contains(r,"price")&&(v=l.price,2===v.length&&(z=parseInt(v[0]),q=parseInt(v[1]),x.greaterThanOrEqualTo("mrp",z),x.lessThanOrEqualTo("mrp",q))),a.contains(r,"otherFilters")&&(u=l.otherFilters,a.isEmpty(u)||(t=a.keys(u),a.each(t,function(b){var c,d,e,f;if(e=u[b],b.indexOf("filter")>-1){if(console.log(e),e.length>0)return c=a.map(e,function(a){var b;return b=new Parse.Object("AttributeValues"),b.id=a,b}),x.containedIn(b,c)}else if(2===e.length)return f=parseInt(e[0]),d=parseInt(e[1]),x.greaterThanOrEqualTo(b,f),x.lessThanOrEqualTo(b,d)})))),x.select("images,name,mrp,brand,primaryAttributes"),x.include("brand"),x.include("primaryAttributes"),x.include("primaryAttributes.attribute"),x.limit(h),x.skip(j*h),e===!0?x.ascending(m):x.descending(m),y=x.find().then(function(b){var c,e,f;return e=[],e=a.map(b,function(a){var b,c;return b={id:a.get("brand").id,name:a.get("brand").get("name")},c={objectId:a.id,name:a.get("name"),brand:b,images:a.get("images"),mrp:a.get("mrp"),primaryAttributes:a.get("primaryAttributes")}}),c=i("product"),f={products:e,filters:g,supportedBrands:A,priceRange:w,sortableAttributes:["mrp","popularity"],imageSizes:c},d.success(f)},function(a){return d.error(a)})},function(a){return d.error(a)})},function(a){return d.error(a)})}),Parse.Cloud.define("getProduct",function(b,c){var d,e,f;return e=b.params.productId,d=Parse.Object.extend("ProductItem"),f=new Parse.Query(d),f.equalTo("objectId",e),f.include("attrs"),f.include("attrs.attribute"),f.include("brand"),f.include("category"),f.include("category.secondary_attributes"),f.include("primaryAttributes"),f.include("primaryAttributes.attribute"),f.first().then(function(b){var d,e,f,g,h,j,k,l,n,o,p,q,r,s;if(j=b.get("category"),h={id:j.id,name:j.get("name")},g=b.get("brand"),f={id:g.id,name:g.get("name")},q=j.get("secondary_attributes"),s=b.get("textAttributes"),e={},q.length>0&&a.each(q,function(b){var c,d,f;return a.isNull(b)?void 0:(d=a.isUndefined(b.get("group"))?"other":b.get("group"),f=a.isUndefined(b.get("name"))?"":b.get("name"),c={group:d,name:f},e[b.id]=c)}),n=b.get("attrs"),r=[],a.each(n,function(b){var c,d,e,f,g;return c=b.get("attribute"),d=c.id,g=a.isUndefined(c.get("unit"))?null:c.get("unit"),f=c.get("group"),e={group:f.toLowerCase(),key:c.get("name"),value:b.get("value"),unit:g},r.push(e)}),!a.isUndefined(s)||!a.isEmpty(s))for(d in s)s.hasOwnProperty(d)&&(l=e[d].group,p={group:l.toLowerCase(),key:e[d].name,value:s[d],unit:null},r.push(p));return k=i("product"),o={id:b.id,name:b.get("name"),modelNumber:b.get("model_number"),mrp:b.get("mrp"),images:b.get("images"),category:h,brand:f,primaryAttributes:b.get("primaryAttributes"),specifications:r,imageSizes:k},m(b).then(function(a){return o.onlinePrice=a.online,o.platformPrice=a.platform,c.success(o)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getProductsNew",function(b,d){var e,f,g,h,j,k,l,m;return f=b.params.categoryId,l=b.params.selectedFilters,m=b.params.sortBy,e=b.params.ascending,j=parseInt(b.params.page),h=parseInt(b.params.displayLimit),k=a.has(b.params,"searchKeywords")?b.params.searchKeywords:"all",g=new Parse.Query("Category"),g.equalTo("objectId",f),g.select("filterable_attributes"),g.select("supported_brands"),g.select("price_range"),g.include("filterable_attributes"),g.include("filterable_attributes.filterAttribute"),g.include("supported_brands"),g.first().then(function(b){var g,n,o;return n=b.get("filterable_attributes"),g=[],o=a.map(n,function(a){return c(a)}),Parse.Promise.when(o).then(function(){var c,n,o,p,q,r,s,t,u,v,w,x,y,z,A;return g=arguments,p=b.get("supported_brands"),A=a.map(p,function(a){var b;return null!==a?b={id:a.id,name:a.get("name")}:void 0}),w=b.get("price_range"),c=Parse.Object.extend("ProductItem"),s=new Parse.Query("Category"),s.equalTo("objectId",f),x=new Parse.Query("ProductItem"),x.matchesQuery("category",s),"all"!==k&&k.length>0&&x.containsAll("searchKeywords",k),"all"!==l&&a.isObject(l)&&(r=Object.keys(l),a.contains(r,"brands")&&(o=l.brands,o.length>0&&(n=a.map(o,function(a){var b;return b=new Parse.Object("Brand"),b.id=a,b}),x.containedIn("brand",n))),a.contains(r,"price")&&(v=l.price,2===v.length&&(z=parseInt(v[0]),q=parseInt(v[1]),x.greaterThanOrEqualTo("mrp",z),x.lessThanOrEqualTo("mrp",q))),a.contains(r,"otherFilters")&&(u=l.otherFilters,a.isEmpty(u)||(t=a.keys(u),a.each(t,function(b){var c,d;return d=u[b],console.log(d),d.length>0?(c=a.map(d,function(a){var b;return b=new Parse.Object("AttributeValues"),b.id=a,b}),x.containedIn(b,c)):void 0})))),x.select("images,name,mrp,brand,primaryAttributes"),x.include("brand"),x.include("primaryAttributes"),x.include("primaryAttributes.attribute"),x.limit(h),x.skip(j*h),e===!0?x.ascending(m):x.descending(m),y=x.find().then(function(b){var c,e,f;return e=[],e=a.map(b,function(a){var b,c;return b={id:a.get("brand").id,name:a.get("brand").get("name")},c={objectId:a.id,name:a.get("name"),brand:b,images:a.get("images"),mrp:a.get("mrp"),primaryAttributes:a.get("primaryAttributes")}}),c=i("product"),f={products:e,filters:g,supportedBrands:A,priceRange:w,sortableAttributes:["mrp","popularity"],imageSizes:c},d.success(f)},function(a){return d.error(a)})},function(a){return d.error(a)})},function(a){return d.error(a)})}),Parse.Cloud.job("updateCategoryProductsKeywords",function(b,c){var d,e,f;return d=b.params.categoryId,e=new Parse.Query("Category"),e.equalTo("objectId",d),f=new Parse.Query("ProductItem"),f.matchesQuery("category",e),f.include("attrs"),f.include("brand"),f.include("brand"),f.ascending("updatedAt"),f.limit(500),f.find().then(function(b){var d;return d=[],d=a.map(b,function(a){return B(a)}),Parse.Promise.when(d).then(function(){return c.success("Success")},function(a){return c.error("Failure")})},function(a){return c.error("Failure")})}),Parse.Cloud.define("getImageSizes",function(a,b){var c;return c={productSizes:i("product"),categorySizes:i("category")},b.success(c)}),i=function(a){return function(a){var b,c,d,e,f,g,h,i;return e={retina:"-600x360",non_retina:"-400x240"},d={retina:"-600x360",non_retina:"-600x360"},g={retina:"-360x216",non_retina:"-180x108"},i={retina:"-300x180",non_retina:"-150x90"},c={largeLandscape:d,largePortrait:e,medium:g,small:i},f={retina:"",non_retina:""},h={retina:"",non_retina:""},b={medium:f,small:h},"category"===a?b:c}}(this),B=function(b){return function(b){var c,d,e,f,g,h,i,j,k;return h=new Parse.Promise,i="",g=b.get("name"),i=i+" "+g,e=b.get("model_number"),i=i+" "+e,d=b.get("brand"),c=d.get("name"),i=i+" "+c,a.isUndefined(b.get("textAttributes"))||(j=b.get("textAttributes"),a.each(j,function(a){return i=i+" "+a})),a.isUndefined(b.get("attrs"))||(f=b.get("attrs"),a.each(f,function(a){var b;return b=a.get("value"),i=i+" "+b})),k=p(i),k=a.map(k,z),b.set("searchKeywords",k),b.save().then(function(a){return h.resolve(a.id)},function(a){return h.reject(a)}),h}}(this),p=function(b){return function(b){var c,d,e;return d=[],b=b.replace(/[^a-zA-Z0-9.]/g," "),b=b.trim(),d=b.split(/\s+/g),d=a.map(d,z),d=a.unique(d),c=["the","is","and"],e=a.filter(d,function(b){return!a.contains(c,b)})}}(this),z=function(a){return a.toLowerCase()},c=function(b){return function(b){var c,d,e,f,g,h,i,j;return i=new Parse.Promise,e=b.get("filterColumn"),c=b.get("filterAttribute").id,d=b.get("filterAttribute").get("name"),g=b.get("filterAttribute").get("type"),f="range"===g?"range":"filter",j=new Parse.Query("AttributeValues"),h=new Parse.Query("Attributes"),h.equalTo("objectId",c),j.matchesQuery("attribute",h),j.find().then(function(b){var g,h;return g=a.map(b,function(a){var b;return b={id:a.id,name:a.get("value")}}),h={filterName:f+(""+e),attributeId:c,attributeName:d,values:g},i.resolve(h)},function(a){return i.reject(a)}),i}}(this),m=function(b){var c,d,f,g,h;return g=new Parse.Promise,f={},d=b.id,h=new Parse.Query("Price"),c=new Parse.Query("ProductItem"),c.equalTo("objectId",d),h.matchesQuery("product",c),h.equalTo("type","online_market_price"),h.ascending("value"),h.first().then(function(c){var d,h,i;return a.isEmpty(c)?f.online={value:"",source:"",sourceUrl:"",updatedAt:""}:(d="https://s3-ap-southeast-1.amazonaws.com/aj-shopoye/products+/Flipkart+logo.jpg",h=" https://s3-ap-southeast-1.amazonaws.com/aj-shopoye/products+/sd.png",i="flipkart"===c.get("source")?d:h,f.online={value:c.get("value"),source:c.get("source"),srcUrl:i,updatedAt:c.updatedAt}),e(b).then(function(a){return f.platform=a,g.resolve(f)},function(a){return g.reject(a)})},function(a){return g.reject(a)}),g},e=function(b){var c,d,e,f;return e=new Parse.Promise,f=new Parse.Query("Price"),d=b.id,c=new Parse.Query("ProductItem"),c.equalTo("objectId",d),f.matchesQuery("product",c),f.notEqualTo("type","online_market_price"),f.find().then(function(b){var c,d,f,g;return 0===b.length?(d={value:"",updatedAt:""},e.resolve(d)):(g=[],f=[],a.each(b,function(a){var b;return b={value:parseInt(a.get("value")),updatedAt:a.updatedAt},f.push(b),g.push(parseInt(a.get("value")))}),c=a.min(g),d=a.where(f,{value:c}),e.resolve(d[0]))},function(a){return e.reject(a)}),e},Parse.Cloud.define("makeRequest",function(b,c){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;return o=b.params.customerId,s=b.params.productId,k=b.params.categoryId,i=b.params.brandId,q=b.params.location,g=b.params.address,m=b.params.city,h=b.params.area,n=b.params.comments,u=b.params.status,e=Parse.Object.extend("Request"),b=new e,r=new Parse.GeoPoint(q),b.set("addressGeoPoint",r),b.set("address",g),b.set("status",u),b.set("city",m),b.set("area",h),b.set("comments",n),b.set("offerCount",0),p={__type:"Pointer",className:"_User",objectId:o},b.set("customerId",p),t={__type:"Pointer",className:"ProductItem",objectId:s},b.set("product",t),l={__type:"Pointer",className:"Category",objectId:k},b.set("category",l),j={__type:"Pointer",className:"Brand",objectId:i},b.set("brand",j),b.save().then(function(b){var e,g;return e=b.id,m=b.get("city"),h=b.get("area"),g=[],f(k,i,m,h).then(function(f){var g;return g=[],g=a.map(f,function(a){var b,c,f,g;return c=a.id,b=a.get("addressGeoPoint"),f=a.get("deliveryRadius"),g="make_request",d(c,b,f,e,g)}),Parse.Promise.when(g).then(function(){var d,f;return d=a.flatten(a.toArray(arguments)),f=[],a.each(d,function(a){var c,d,g,h,i;return d=a.sellerId,d?(i={__type:"Pointer",className:"_User",objectId:d},b={__type:"Pointer",className:"Request",objectId:e},h={hasSeen:!1,recipientUser:i,channel:"push",processed:!1,type:"Request",requestObject:b},c=Parse.Object.extend("Notification"),g=new c(h),f.push(g)):void 0}),Parse.Object.saveAll(f).then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getNewRequests",function(a,b){var c,d,e,f,g,h,i,k,l;return i=a.params.sellerId,f=a.params.city,c=a.params.area,k=a.params.sellerLocation,l=a.params.sellerRadius,e=a.params.categories,d=a.params.brands,g=a.params.productMrp,h={city:f,area:c,sellerLocation:k,sellerRadius:l,categories:e,brands:d,productMrp:g},j(i,h).then(function(a){return b.success(a)},function(a){return b.error(a)})}),Parse.Cloud.define("updateRequestStatus",function(b,c){var d,e,f,g,h,i;return g=b.params.requestId,h=b.params.status,e=b.params.failedDeliveryReason,i=["pending_delivery","sent_for_delivery","failed_delivery","successful","cancelled"],f=a.indexOf(i,h),f>-1?(d=Parse.Object.extend("Request"),b=new d,b.id=g,b.set("status",h),"failed_delivery"===h&&b.set("failedDeliveryReason",e),b.save().then(function(b){var d,e,f,h,i;return f=b.get("status"),g=b.id,h=b.get("customerId"),console.log("requesting customer"),console.log(b),"cancelled"===f?(e=new Parse.Query("Notification"),d=new Parse.Query("Request"),d.equalTo("objectId",g),e.equalTo("type","Request"),e.matchesQuery("requestObject",d),e.include("recipientUser"),e.find().then(function(d){var e,f;return f=a.map(d,function(a){return a.get("recipientUser")}),e=[],a.each(f,function(a){var c,d,f;return f={hasSeen:!1,recipientUser:a,channel:"push",processed:!1,type:"CancelledRequest",requestObject:b},c=Parse.Object.extend("Notification"),d=new c(f),e.push(d)}),Parse.Object.saveAll(e).then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})):"sent_for_delivery"===f||"failed_delivery"===f||"successful"===f?b.fetch().then(function(a){var d,e,g,i;return h=b.get("customerId"),"sent_for_delivery"===f?i="SentForDeliveryRequest":"failed_delivery"===f?i="FailedDeliveryRequest":"successful"===f&&(i="SuccessfulRequest"),g={hasSeen:!1,recipientUser:h,channel:"push",processed:!1,type:i,requestObject:b},d=Parse.Object.extend("Notification"),e=new d(g),e.save().then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)}):(i={requestId:g,requestStatus:b.get("status")},c.success(i))},function(a){return c.error(a)})):c.error("Please enter a valid status")}),Parse.Cloud.define("getCustomerRequests",function(b,c){var d,e,f,g,h,i,j,k,l,m,n,p,q,r,s,t,u,v,w,x,y;return f=b.params.customerId,q=b.params.productId,p=parseInt(b.params.page),h=parseInt(b.params.displayLimit),v=b.params.requestType,w=b.params.selectedFilters,x=b.params.sortBy,g=b.params.descending,d=new Date,e=d.getTime(),i=24,r=new Date,y=e-60*i*60*1e3,r.setTime(y),"expired"===v?(u=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),u.matchesQuery("customerId",j),""!==q&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",q),u.matchesQuery("product",l)),u.equalTo("status","open"),u.lessThanOrEqualTo("createdAt",r)):"nonexpired"===v?(s=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),s.matchesQuery("customerId",j),""!==q&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",q),s.matchesQuery("product",l)),s.equalTo("status","open"),s.greaterThanOrEqualTo("createdAt",r),n=0===w.length?["cancelled","pending_delivery","failed_delivery","sent_for_delivery","successful"]:a.without(w,"open"),t=new Parse.Query("Request"),k=new Parse.Query(Parse.User),k.equalTo("objectId",f),t.matchesQuery("customerId",k),""!==q&&(m=new Parse.Query("ProductItem"),m.equalTo("objectId",q),t.matchesQuery("product",m)),t.containedIn("status",n),u=a.indexOf(w,"open")>-1||0===w.length?Parse.Query.or(s,t):t):"all"===v&&(u=new Parse.Query("Request"),j=new Parse.Query(Parse.User),j.equalTo("objectId",f),u.matchesQuery("customerId",j),""!==q&&(l=new Parse.Query("ProductItem"),l.equalTo("objectId",q),u.matchesQuery("product",l))),u.include("product"),g===!0?u.descending("updatedAt"):u.ascending("updatedAt"),u.limit(h),u.skip(p*h),u.find().then(function(b){var d;return d=a.map(b,function(a){return o(a)}),Parse.Promise.when(d).then(function(){var b;return b=a.flatten(a.toArray(arguments)),c.success(b)},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getSingleRequest",function(b,c){var d,e,f;return e=b.params.requestId,f={id:b.params.sellerId,geoPoint:b.params.sellerGeoPoint},d=new Parse.Query("Request"),d.equalTo("objectId",e),d.include("product"),d.include("category"),d.include("category.parent_category"),d.include("brand"),d.first().then(function(b){var d,e,g;return g={},d=new Parse.Query(Parse.User),d.equalTo("objectId",f.id),e=new Parse.Query("Offer"),e.matchesQuery("seller",d),e.include("request"),e.include("request.product"),e.include("request.category"),e.include("request.category.parent_category"),e.include("price"),e.descending("createdAt"),e.find().then(function(d){var e,h,i;return g={},i=[],h={},a.each(d,function(a){var b,c,d,e,f,i;return i=a.get("request"),f=i.get("product"),e=f.id,d=a.get("price"),c=d.get("value"),g[e]=c,b=a.get("deliveryTime"),h[e]=b}),e=[],e[0]=g,e[1]=h,n(b,f,e).then(function(a){return c.success(a)},function(a){return c.error(a)})},function(a){return c.error(a)})},function(a){return c.error(a)})}),Parse.Cloud.define("getOpenRequestCount",function(b,c){var d,e,f,g,h,i,j,k;return f=b.params.customerId,h=new Parse.Query(Parse.User),h.equalTo("objectId",f),j=new Parse.Query("Request"),j.matchesQuery("customerId",h),j.equalTo("status","open"),d=new Date,e=d.getTime(),g=24,i=new Date,k=e-60*g*60*1e3,i.setTime(k),j.greaterThanOrEqualTo("createdAt",i),j.find().then(function(b){var d,e,f;return e=b.length,d=0,0===e?d=0:a.each(b,function(a){return d+=a.get("offerCount")}),f={requestCount:e,offerCount:d},c.success(f)},function(a){return c.error(a)})}),Parse.Cloud.define("getRequestDetails",function(b,c){var d,e,f,g;return d=b.params.offerId,g=b.params.requestId,a.isEmpty(d)?a.isEmpty(g)?void 0:(f=new Parse.Query("Request"),f.equalTo("objectId",g),f.include("product"),f.first().then(function(a){var b;return b=a.get("product"),m(b).then(function(d){var e,f;return e={name:b.get("name"),images:b.get("images"),mrp:b.get("mrp"),onlinePrice:d.online.value,platformPrice:d.platform.value},f={id:a.id,product:e,status:a.get("status"),address:a.get("address"),comments:a.get("comments"),createdAt:a.createdAt,updatedAt:a.updatedAt,offerCount:a.get("offerCount")},c.success(f)},function(a){return c.error(a)})},function(a){return c.error(a)})):(e=new Parse.Query("Offer"),e.equalTo("objectId",d),e.select("request"),e.include("request"),e.include("request.product"),e.first().then(function(a){var b,d;return d=a.get("request"),b=d.get("product"),m(b).then(function(a){var e,f,g;return f={name:b.get("name"),images:b.get("images"),mrp:b.get("mrp"),onlinePrice:a.online.value,platformPrice:a.platform.value},e=i("product"),g={id:d.id,product:f,status:d.get("status"),address:d.get("address"),comments:d.get("comments"),createdAt:d.createdAt,updatedAt:d.updatedAt,offerCount:d.get("offerCount"),imageSizes:e},c.success(g)},function(a){return c.error(a)})},function(a){return c.error(a)}))}),j=function(b,c){var d,e,f,g,h,i,j,k,l,m;return i=new Parse.Promise,g=c.city,d=c.area,j=c.sellerLocation,l=c.sellerRadius,f=c.categories,e=c.brands,h=c.productMrp,m="open",k=new Parse.Query(Parse.User),k.equalTo("objectId",b),k.include("supportedCategories"),k.include("supportedBrands"),k.first().then(function(c){var k,o,p,q,r,s,t,u,v,w;return o=Parse.Object.extend("Category"),k=Parse.Object.extend("Brand"),w=c.get("supportedCategories"),v=c.get("supportedBrands"),q=[],a.each(w,function(a){var b;return b={id:a.id,name:a.get("name")},q.push(b)}),p=[],a.each(v,function(a){var b;return b={id:a.id,name:a.get("name")},p.push(b)}),"default"===f?u=w:(u=[],a.each(f,function(a){var b;return b=new o,b.id=a,u.push(b)})),"default"===e?t=v:(t=[],a.each(e,function(a){var b;return b=new k,b.id=a,t.push(b)})),"default"===g&&(g=c.get("city")),"default"===d&&(d=c.get("area")),j="default"===j?c.get("addressGeoPoint"):j,l="default"===l?c.get("deliveryRadius"):parseInt(l),r=new Parse.Query(Parse.User),r.equalTo("objectId",b),s=new Parse.Query("Offer"),s.matchesQuery("seller",r),s.include("request"),s.include("request.product"),s.include("price"),s.descending("createdAt"),s.find().then(function(c){var e,f,k,o,r,s,v,w,x,y,z,A,B,C;return w={},v={},z=[],a.each(c,function(a){var b,c,d,e,f,g;return g=a.get("request"),f=g.get("product"),e=f.id,d=a.get("price"),c=d.get("value"),w[e]=c,b=a.get("deliveryTime"),v[e]=b,z.push(a.get("request").id)}),s=[],s[0]=w,s[1]=v,y=new Parse.Query("Request"),y.containedIn("category",u),y.containedIn("brand",t),y.equalTo("status",m),e=new Date,f=e.getTime(),o=24,x=new Date,C=f-60*o*60*1e3,x.setTime(C),y.greaterThanOrEqualTo("createdAt",x),A=new Parse.GeoPoint(j),y.withinKilometers("addressGeoPoint",A,l),y.notContainedIn("objectId",z),"default"!==h&&(B=parseFloat(h[0]),k=parseFloat(h[1]),r=new Parse.Query("ProductItem"),-1===B?r.lessThanOrEqualTo("mrp",k):-1===k?r.greaterThanOrEqualTo("mrp",B):(r.lessThanOrEqualTo("mrp",k),r.greaterThanOrEqualTo("mrp",B)),y.matchesQuery("product",r)),y.include("product"),y.include("category"),y.include("category.parent_category"),y.include("brand"),y.find().then(function(c){var e,f;return e=[],f={id:b,geoPoint:A},e=a.map(c,function(a){var b;return b=n(a,f,s)}),Parse.Promise.when(e).then(function(){var b,c;return b=a.flatten(a.toArray(arguments)),c={city:g,area:d,radius:l,location:j,requests:b,sellerCategories:q,sellerBrands:p},i.resolve(c)})},function(a){return i.reject(a)})},function(a){return i.reject(a)})},function(a){return i.reject(a)}),i},n=function(b,c,d){var e,f,g,h,j,k,l,n;return k=new Parse.Promise,j=d[0],h=d[1],n=c.id,l=c.geoPoint,e=b.get("product"),g=e.id,f={id:e.id,name:e.get("name"),mrp:e.get("mrp"),image:e.get("images"),model_number:e.get("model_number")},m(e).then(function(c){var d,e,m,o,p,q,r,s,t,u,v,w,x,y,z;return o=b.get("category"),m={id:o.id,name:o.get("name"),parent:o.get("parent_category").get("name")},e=b.get("brand"),d={id:e.id,name:e.get("name")},z=b.get("addressGeoPoint"),x=z.kilometersTo(l),u=a.keys(j),s=a.indexOf(u,g)>-1?j[g]:"",v=a.keys(h),t=a.indexOf(v,g)>-1?h[g]:"",p=i("product"),y={id:b.id,radius:x,product:f,category:m,brand:d,createdAt:b.createdAt,comments:b.get("comments"),status:b.get("status"),offerCount:b.get("offerCount"),lastOfferPrice:s,lastDeliveryTime:t,onlinePrice:c.online.value,platformPrice:c.platform.value,imageSizes:p},w=new Parse.Query("Notification"),r=new Parse.Query(Parse.User),r.equalTo("objectId",n),w.matchesQuery("recipientUser",r),w.equalTo("type","Request"),q=new Parse.Query("Request"),q.equalTo("objectId",b.id),w.matchesQuery("requestObject",q),w.first().then(function(c){var d,e,f,g;return a.isEmpty(c)?(d=Parse.Object.extend("Notification"),f=new d,g={__type:"Pointer",className:"_User",objectId:n},f.set("channel","push_copy"),f.set("type","Request"),f.set("processed",!0),f.set("requestObject",b),f.set("recipientUser",g),f.set("hasSeen",!1),f.save().then(function(a){return e={hasSeen:a.get("hasSeen")},y.notification=e,k.resolve(y)})):(e={hasSeen:c.get("hasSeen")},y.notification=e,k.resolve(y))},function(a){return k.reject(a)})},function(a){return k.reject(a)}),k},o=function(a){var b,c,d,e,f,g,h;return g=new Parse.Promise,c=new Date,b=a.createdAt,d=c.getTime()-b.getTime(),e=Math.floor(d/864e5),h=a.get("status"),e>=1&&"open"===h&&(h="expired"),f=a.get("product"),m(f).then(function(b){var c,d;return d={id:f.id,name:f.get("name"),images:f.get("images"),mrp:f.get("mrp"),onlinePrice:b.online.value,platformPrice:b.platform.value},c={id:a.id,product:d,status:h,createdAt:a.createdAt,updatedAt:a.updatedAt,differenceInDays:e,address:a.get("address"),comments:a.get("comments"),offerCount:a.get("offerCount")},g.resolve(c)},function(a){return g.reject(a)}),g},f=function(a,b,c,d){var e,f,g,h,i,j;return j=new Parse.Query(Parse.User),f=Parse.Object.extend("Category"),h=new f,h.id=a,e=Parse.Object.extend("Brand"),g=new e,g.id=b,j.equalTo("userType","seller"),j.equalTo("city",c),j.equalTo("area",d),j.equalTo("supportedCategories",h),j.equalTo("supportedBrands",g),i=new Parse.Promise,j.find().then(function(a){return 0===a.length?i.resolve():i.resolve(a)},function(a){return i.reject(a)}),i},d=function(a,b,c,d,e){var f,g;return g="find_sellers"===e?new Parse.Query("LocationRequests"):new Parse.Query("Request"),g.equalTo("objectId",d),g.withinKilometers("addressGeoPoint",b,c),f=new Parse.Promise,g.find().then(function(c){var d;return 0===c.length?f.resolve():(d={sellerId:a,sellerGeoPoint:b},f.resolve(d))},function(a){return f.reject(a)}),f},Parse.Cloud.define("getLocationBasedSellers",function(b,c){var e,g,h,i,j,k,l,m,n,o;return m={latitude:b.params.location.latitude,longitude:b.params.location.longitude},j=b.params.categoryId,h=b.params.brandId,l=b.params.city,g=b.params.area,e=Parse.Object.extend("LocationRequests"),o=new e,n=new Parse.GeoPoint(m),o.set("addressGeoPoint",n),o.set("city",l),o.set("area",g),k={__type:"Pointer",className:"Category",objectId:j},o.set("category",k),i={__type:"Pointer",className:"Brand",objectId:h},o.set("brand",i),o.save().then(function(b){var e,i;return e=b.id,l=b.get("city"),g=b.get("area"),i=[],f(j,h,l,g).then(function(f){var g;return console.log("categoryBasedSellers"),console.log(f),g=[],g=a.map(f,function(a){var b,c,f,g;return c=a.id,b=a.get("addressGeoPoint"),f=a.get("deliveryRadius"),g="find_sellers",d(c,b,f,e,g)}),Parse.Promise.when(g).then(function(){var d;return b.destroy(),d=a.flatten(a.toArray(arguments)),c.success(d)},function(a){return c.error(a)})})})}),Parse.Cloud.define("createTestSeller",function(b,c){var d,e,f,g,h,i,j;return d=new Parse.GeoPoint(b.params.addressLocation),j={username:b.params.username,password:b.params.password,email:b.params.email,addressGeoPoint:d,address:b.params.address,city:b.params.city,deliveryRadius:b.params.deliveryRadius},h=[],g=b.params.supportedCategories,a.each(g,function(a){var b;return b={__type:"Pointer",className:"Category",objectId:a},h.push(b)}),j.supportedCategories=h,f=[],e=b.params.supportedBrands,a.each(e,function(a){var b;return b={__type:"Pointer",className:"Brand",objectId:a},f.push(b)}),j.supportedBrands=f,j.userType="seller",i=new Parse.User(j),i.signUp().done(function(a){return function(a){return c.success(a)}}(this)).fail(function(a){return function(a){return c.error("Failed to create user "+a.message)}}(this))}),Parse.Cloud.define("updateSellerRating",function(a,b){var c,d,e,f,g,h,i,j;return f=a.params.customerId,j=a.params.sellerId,g=a.params.ratingInStars,d=a.params.comments,c=Parse.Object.extend("Ratings"),h=new c,e=new Parse.User,e.id=f,i=new Parse.User,i.id=j,h.set("ratingBy",e),h.set("ratingForType","seller"),h.set("ratingFor",i),h.set("count",g),h.set("comments",d),h.save().then(function(a){var c;return c=new Parse.Query(Parse.User),c.equalTo("objectId",j),c.first().then(function(a){var c,d,e;return d=a.get("ratingSum"),c=a.get("ratingCount"),e=d+g,a.set("ratingSum",e),a.increment("ratingCount"),a.save().then(function(a){var c,d,e,f;return e=a.get("ratingSum"),d=a.get("ratingCount"),c=e/d,f={sellerId:j,avgRatings:c},b.success(f)},function(a){return b.error(a)})})},function(a){return b.error(a)})}),Parse.Cloud.useMasterKey(),Parse.Cloud.define("sendSMSCode",function(b,c){var d,e,f,g,h,i,j;return g=b.params.phone,d=(Math.floor(9e5*Math.random())+1e5).toString(),e=b.params.displayName,j=b.params.userType,f=function(a){return c.error(a)},i=function(a,b){return b>3?c.success({attemptsExceeded:!0}):a.save({phone:g,verificationCode:d,attempts:b,displayName:e,userType:j}).then(function(){return c.success({code:d,attemptsExceeded:!1})},f)},h=new Parse.Query("SMSVerify"),h.equalTo("phone",g),h.find().then(function(b){var c,d,e;return a.isEmpty(b)?(c=Parse.Object.extend("SMSVerify"),e=new c,i(e,1)):(b=b[0],d=b.get("attempts"),i(b,d+1))},f)}),Parse.Cloud.afterSave("SMSVerify",function(a){var b,c,d;return b=a.object,c=b.get("phone"),d=b.get("verificationCode"),Parse.Cloud.httpRequest({url:"https://rest.nexmo.com/sms/json",params:{api_key:"e2f79907",api_secret:"88907392",from:"ShopOye",to:"91"+c,text:"Welcome to ShopOye. Your one time verification code is "+d}}).then(function(a){return console.log("SMS Sent: "+c)},function(a){return console.log("SMS Error")})}),Parse.Cloud.define("verifySMSCode",function(a,b){var c,d,e;return d=a.params.phone,c=a.params.code,e=new Parse.Query("SMSVerify"),e.equalTo("phone",d),e.find().then(function(a){var d,e;return a=a[0],d=a.get("verificationCode"),e=d===c?!0:!1,e&&a.destroy(),b.success({verified:e})},function(a){return b.error(a)})})}).call(this);